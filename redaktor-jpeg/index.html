<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–ª–æ–∂–µ–∫ –¥–ª—è –≤–∫</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
/* –í–∞—à–∏ —Å—Ç–∏–ª–∏ */
body {
  margin: 0; padding: 8px; font-family: Arial, sans-serif;
  background: url("https://raw.githubusercontent.com/NEW-nik-1/R-tv/refs/heads/main/redaktor-jpeg/background-vk.jpg") no-repeat center center fixed;
  background-size: cover; color: #e0e0e0; display: flex; justify-content: center;
}
.container {width: 680px; text-align: center;}
h2 {font-size: 16px; margin-bottom: 6px;}
#canvasWrap {padding: 4px; box-shadow: 0 0 4px #999; margin-bottom: 12px;}
canvas {
  background: #222; cursor: grab;
  width: 640px; height: 252px; border-radius: 4px;
}
.flex-row, .links-buttons {
  display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 12px;
}
button, .icon-btn {
  font-size: 11px; padding: 6px 12px; border-radius: 4px;
  cursor: pointer; display: flex; align-items: center; gap: 4px;
  transition: all 0.2s ease;
}
button:hover, .icon-btn:hover {
  background-color: #bdb76b; color: #fff; transform: scale(1.05); box-shadow: 0 0 6px rgba(0,0,0,0.4);
}
#scaleControl {
  width: 640px; display: none; margin-bottom: 12px; justify-content: center; align-items: center;
}
.slider-wrapper {
  display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
.author-label {
  font-size: 11px; color: rgba(180,180,180,0.4); text-decoration: none;
  display: inline-block; padding: 3px 6px; background: #222; border-radius: 4px; margin-top: 60px;
}
#smoothingToggleLabel {
  font-size: 12px; margin-left: 12px; user-select: none; align-items: center; display: flex; gap: 6px;
}
.modal {
  display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
}
.modal-content {
  background-color: #222; margin: 6% auto; padding: 20px; border-radius: 8px;
  width: 80%; max-width: 640px; color: #ddd; font-size: 14px; line-height: 1.5;
  box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: left;
}
.modal-content h2 {
  margin-top: 0; color: #ffcc66;
}
.close {
  color: #aaa; float: right; font-size: 22px; font-weight: bold; cursor: pointer;
}
.close:hover {color: #fff;}
</style>
</head>
<body>
<div class="container">
  <h2>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–ª–æ–∂–µ–∫ –¥–ª—è –≤–∫</h2>

  <div class="flex-row">
    <button id="loadBgBtn"><i class="fa-solid fa-image"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
    <input type="file" id="bgFile" accept="image/*" style="display:none;" />
    <button id="addImg1Btn"><i class="fa-solid fa-photo-film"></i> –ö–∞—Ä—Ç–∏–Ω–∫–∞ 1</button>
    <input type="file" id="addImgFile1" accept="image/*" style="display:none;" />
    <button id="addImg2Btn"><i class="fa-solid fa-photo-film"></i> –ö–∞—Ä—Ç–∏–Ω–∫–∞ 2</button>
    <input type="file" id="addImgFile2" accept="image/*" style="display:none;" />
    <button id="helpBtn"><i class="fa-solid fa-circle-question"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
  </div>

  <div id="canvasWrap"><canvas id="canvas" width="640" height="252"></canvas></div>

  <div class="flex-row" style="justify-content:center; margin-bottom:12px;">
    <label style="font-size:12px;">–ú–∞—Å—à—Ç–∞–± —Ñ–æ–Ω–∞:</label>
    <button id="bgScaleDecrease" style="font-size:16px;">‚àí</button>
    <input type="range" id="bgScaleSlider" min="50" max="300" value="100" style="width:180px;" />
    <button id="bgScaleIncrease" style="font-size:16px;">+</button>
    <span id="bgScaleValue">100%</span>
  </div>

  <div id="scaleControl">
    <label style="font-size:12px;">–†–∞–∑–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ (px)</label>
    <div class="slider-wrapper">
      <div class="icon-btn" id="decrease">‚àí</div>
      <input type="range" id="scaleSlider" min="50" max="500" step="1" value="200" />
      <div class="icon-btn" id="increase">+</div>
      <span id="scaleValue">200</span>
      <label style="display:flex; align-items:center; gap:4px; font-size:12px; margin-left:8px;">
        <input type="checkbox" id="flipHoriz" /> <i class="fa-solid fa-arrows-left-right"></i> –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
      </label>
    </div>
  </div>

  <label id="smoothingToggleLabel">
    <input type="checkbox" id="toggleSmoothing" checked />
    –í–∫–ª—é—á–∏—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞—ë–≤
  </label>

  <div class="flex-row">
    <select id="formatSelect">
      <option value="jpeg">JPG</option>
      <option value="png">PNG</option>
    </select>
    <input type="number" id="widthInput" value="1920" min="100" style="width:60px;" /> √ó
    <input type="number" id="heightInput" value="768" min="100" style="width:60px;" />
    <button id="saveImageBtn"><i class="fa-solid fa-download"></i> –°–∫–∞—á–∞—Ç—å</button>
  </div>

  <div class="links-buttons">
    <button onclick="window.open('https://www.photoroom.com/ru/instrumenty/ubrat-fon-onlayn', '_blank')"><i class="fa-solid fa-scissors"></i> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω (Photoroom)</button>
    <button onclick="window.open('https://carve.photos/', '_blank')"><i class="fa-solid fa-cut"></i> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω (Carve.photos)</button>
    <button onclick="window.open('https://ru.textstudio.com/', '_blank')"><i class="fa-solid fa-font"></i> –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç (TextStudio)</button>
    <button onclick="window.open('https://textdrom.com/vintage-text-effect.html', '_blank')"><i class="fa-solid fa-font"></i> –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç (TextDrom)</button>
  </div>

  <div><a class="author-label" href="https://vk.com/muzer_play" target="_blank"><i class="fa-solid fa-user"></i> –ê–≤—Ç–æ—Ä: MUZER play + ( ChatGPT )</a></div>
</div>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –æ–±–ª–æ–∂–µ–∫</h2>
    <ol>
      <li><b>–ó–∞–ø—É—Å–∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞</b><br>–ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±–ª–æ–∂–∫–∏.</li><br>
      <li><b>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞</b><br>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω¬ª ‚Üí –≤—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Üí —Ñ–æ–Ω –∑–∞–π–º–µ—Ç –≤–µ—Å—å —Ö–æ–ª—Å—Ç.</li><br>
      <li><b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫</b><br>–ù–∞–∂–º–∏ ¬´–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1¬ª –∏–ª–∏ ¬´–ö–∞—Ä—Ç–∏–Ω–∫–∞ 2¬ª ‚Üí –≤—ã–±–µ—Ä–∏ —Ñ–∞–π–ª ‚Üí —ç–ª–µ–º–µ–Ω—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞.</li><br>
      <li><b>–†–∞–±–æ—Ç–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏</b><br>üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ ‚Äî –ø–µ—Ä–µ—Ç–∞—â–∏ –º—ã—à–∫–æ–π.<br>üîç –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ–ª–∑—É–Ω–æ–∫ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ ¬´+¬ª –∏ ¬´‚àí¬ª.<br>‚Üî –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç ‚Äî –≥–∞–ª–æ—á–∫–∞ ¬´–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ¬ª.<br>‚ùå –£–¥–∞–ª–µ–Ω–∏–µ ‚Äî –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞).</li><br>
      <li><b>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–ª–æ–∂–∫–∏</b><br>–í—ã–±–µ—Ä–∏ —Ñ–æ—Ä–º–∞—Ç JPG/PNG, —Ä–∞–∑–º–µ—Ä—ã, –Ω–∞–∂–º–∏ ¬´–°–∫–∞—á–∞—Ç—å¬ª.</li><br>
      <li><b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏</b><br>–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ —Ç–µ–∫—Å—Ç—ã —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫–∏.</li><br>
      <li><b>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞—ë–≤</b><br>–ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –ø–ª–∞–≤–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–µ–≤–æ–≥–æ –∏ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–ª–∞–µ—Ç –±–æ–∫–æ–≤—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –º—è–≥–∫–∏–º–∏, —É—Å—Ç—Ä–∞–Ω—è—è —Ä–µ–∑–∫–∏–µ –æ–±—Ä—É–±–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –æ–±–ª–æ–∂–∫–∏.</li><br>
      <li><b>–°–æ–≤–µ—Ç—ã</b><br>–°–Ω–∞—á–∞–ª–∞ —Ñ–æ–Ω, –ø–æ—Ç–æ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–π –∏ —Ä–∞–∑–º–µ—â–∞–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.</li>
    </ol>

    <h3>üé¨ –í–∏–¥–µ–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
    <video width="100%" controls>
      <source src="video-instruction.mp4" type="video/mp4" />
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ —Ç–µ–≥.
    </video>
  </div>
</div>

<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
(async () => {
  try {
    await vkBridge.send("VKWebAppInit");
    console.log("VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  } catch (e) {
    console.warn("VK Bridge initialization failed or unavailable", e);
  }
})();

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let bgImage = null;
let images = [];
let selectedIndex = -1,
  dragging = false;
let dragOffsetX = 0,
  dragOffsetY = 0;

const scaleControl = document.getElementById("scaleControl");
const scaleSlider = document.getElementById("scaleSlider");
const scaleValue = document.getElementById("scaleValue");
const decreaseBtn = document.getElementById("decrease");
const increaseBtn = document.getElementById("increase");
const flipCheckbox = document.getElementById("flipHoriz");

const bgScaleSlider = document.getElementById("bgScaleSlider");
const bgScaleValue = document.getElementById("bgScaleValue");
const bgScaleDecrease = document.getElementById("bgScaleDecrease");
const bgScaleIncrease = document.getElementById("bgScaleIncrease");

let lastOffsetX = 40,
  lastOffsetY = 40;
let smoothingEnabled = true;
let bgScale = 1.0;
let bgPosX = 0,
  bgPosY = 0;
let draggingBg = false,
  dragStartX = 0,
  dragStartY = 0;

class ImageObject {
  constructor(img, x = 0, y = 0) {
    this.img = img;
    this.x = x;
    this.y = y;
    this.width = 200;
    this.height = (200 * img.height) / img.width;
    this.flip = false;
  }
}

function drawImageWithSmoothEdges(ctx, imgObj) {
  const tmpCanvas = document.createElement("canvas");
  tmpCanvas.width = imgObj.width;
  tmpCanvas.height = imgObj.height;
  const tmpCtx = tmpCanvas.getContext("2d");

  tmpCtx.imageSmoothingEnabled = smoothingEnabled;
  tmpCtx.imageSmoothingQuality = smoothingEnabled ? "high" : "low";

  tmpCtx.clearRect(0, 0, tmpCanvas.width, tmpCanvas.height);
  tmpCtx.drawImage(imgObj.img, 0, 0, imgObj.width, imgObj.height);

  if (smoothingEnabled) {
    let gradient = tmpCtx.createLinearGradient(0, 0, tmpCanvas.width, 0);
    const fadeWidth = Math.min(30, tmpCanvas.width / 4);

    gradient.addColorStop(0, "rgba(0,0,0,0)");
    gradient.addColorStop(fadeWidth / tmpCanvas.width, "rgba(0,0,0,1)");
    gradient.addColorStop(1 - fadeWidth / tmpCanvas.width, "rgba(0,0,0,1)");
    gradient.addColorStop(1, "rgba(0,0,0,0)");

    tmpCtx.globalCompositeOperation = "destination-in";
    tmpCtx.fillStyle = gradient;
    tmpCtx.fillRect(0, 0, tmpCanvas.width, tmpCanvas.height);
    tmpCtx.globalCompositeOperation = "source-over";
  }

  ctx.save();
  ctx.translate(imgObj.x + imgObj.width / 2, imgObj.y + imgObj.height / 2);
  ctx.scale(imgObj.flip ? -1 : 1, 1);
  ctx.drawImage(tmpCanvas, -imgObj.width / 2, -imgObj.height / 2);
  ctx.restore();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (bgImage) {
    const scaledWidth = bgImage.width * bgScale;
    const scaledHeight = bgImage.height * bgScale;
    ctx.drawImage(bgImage, bgPosX, bgPosY, scaledWidth, scaledHeight);
  }
  images.forEach((img) => {
    drawImageWithSmoothEdges(ctx, img);
  });
}

function addImage(input) {
  const f = input.files[0];
  if (!f) return;
  const img = new Image();
  img.onload = () => {
    lastOffsetX += 20;
    lastOffsetY += 20;
    if (lastOffsetX > canvas.width - 200) lastOffsetX = 40;
    if (lastOffsetY > canvas.height - 200) lastOffsetY = 40;
    const imgObj = new ImageObject(img, lastOffsetX, lastOffsetY);
    images.push(imgObj);
    selectedIndex = images.length - 1;
    updateScaleControl(imgObj);
    draw();
  };
  img.src = URL.createObjectURL(f);
  input.value = "";
}

function updateScaleControl(imgObj) {
  scaleSlider.value = imgObj.width;
  scaleValue.textContent = imgObj.width;
  flipCheckbox.checked = imgObj.flip;
  scaleControl.style.display = "flex";
}

document.getElementById("loadBgBtn").onclick = () =>
  document.getElementById("bgFile").click();

document.getElementById("bgFile").addEventListener("change", (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const img = new Image();
  img.onload = () => {
    bgImage = img;
    bgPosX = (canvas.width - bgImage.width) / 2;
    bgPosY = (canvas.height - bgImage.height) / 2;
    bgScale = 1.0;
    bgScaleSlider.value = 100;
    bgScaleValue.textContent = "100%";
    draw();
  };
  img.src = URL.createObjectURL(f);
  e.target.value = ""; // –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
});

document.getElementById("addImg1Btn").onclick = () =>
  document.getElementById("addImgFile1").click();

document.getElementById("addImg2Btn").onclick = () =>
  document.getElementById("addImgFile2").click();

document.getElementById("addImgFile1").addEventListener("change", (e) => addImage(e.target));
document.getElementById("addImgFile2").addEventListener("change", (e) => addImage(e.target));

// === –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ —Ñ–æ–Ω–∞ ===
canvas.addEventListener("mousedown", (e) => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  dragging = false;
  // –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
  for (let i = images.length - 1; i >= 0; i--) {
    const img = images[i];
    if (mouseX >= img.x && mouseX <= img.x + img.width &&
        mouseY >= img.y && mouseY <= img.y + img.height) {
      selectedIndex = i;
      dragOffsetX = mouseX - img.x;
      dragOffsetY = mouseY - img.y;
      dragging = true;
      updateScaleControl(img);
      draw();
      return;
    }
  }

  // —Ñ–æ–Ω
  if (bgImage) {
    const scaledWidth = bgImage.width * bgScale;
    const scaledHeight = bgImage.height * bgScale;
    if (mouseX >= bgPosX && mouseX <= bgPosX + scaledWidth &&
        mouseY >= bgPosY && mouseY <= bgPosY + scaledHeight) {
      draggingBg = true;
      dragStartX = mouseX - bgPosX;
      dragStartY = mouseY - bgPosY;
      return;
    }
  }
});

canvas.addEventListener("mousemove", (e) => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  if (draggingBg) {
    bgPosX = mouseX - dragStartX;
    bgPosY = mouseY - dragStartY;
    draw();
  } else if (dragging && selectedIndex >= 0) {
    const img = images[selectedIndex];
    img.x = mouseX - dragOffsetX;
    img.y = mouseY - dragOffsetY;
    draw();
  }
});

window.addEventListener("mouseup", () => {
  dragging = false;
  draggingBg = false;
});

// === –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø—Ä–∞–≤—ã–º –∫–ª–∏–∫–æ–º ===
canvas.addEventListener("contextmenu", (e) => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  for (let i = images.length - 1; i >= 0; i--) {
    const img = images[i];
    if (mouseX >= img.x && mouseX <= img.x + img.width &&
        mouseY >= img.y && mouseY <= img.y + img.height) {
      images.splice(i, 1);
      if (images.length > 0) {
        selectedIndex = images.length - 1;
        updateScaleControl(images[selectedIndex]);
      } else {
        selectedIndex = -1;
        scaleControl.style.display = "none";
      }
      draw();
      return;
    }
  }
});

// === –ú–∞—Å—à—Ç–∞–± –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ ===
function updateImageSize(width) {
  if (selectedIndex >= 0) {
    const imgObj = images[selectedIndex];
    imgObj.width = width;
    imgObj.height = (width * imgObj.img.height) / imgObj.img.width;
    scaleSlider.value = width;
    scaleValue.textContent = width;
    draw();
  }
}

scaleSlider.addEventListener("input", () => updateImageSize(parseInt(scaleSlider.value)));
decreaseBtn.addEventListener("click", () => updateImageSize(Math.max(50, parseInt(scaleSlider.value) - 10)));
increaseBtn.addEventListener("click", () => updateImageSize(Math.min(500, parseInt(scaleSlider.value) + 10)));
flipCheckbox.addEventListener("change", () => {
  if (selectedIndex >= 0) {
    images[selectedIndex].flip = flipCheckbox.checked;
    draw();
  }
});

// === –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞—ë–≤ ===
document.getElementById("toggleSmoothing").addEventListener("change", (e) => {
  smoothingEnabled = e.target.checked;
  draw();
});

// === –ú–∞—Å—à—Ç–∞–± —Ñ–æ–Ω–∞ ===
bgScaleSlider.addEventListener("input", () => {
  bgScale = bgScaleSlider.value / 100;
  bgScaleValue.textContent = Math.round(bgScale * 100) + "%";
  draw();
});
bgScaleDecrease.addEventListener("click", () => {
  bgScale = Math.max(0.5, bgScale - 0.1);
  bgScaleSlider.value = bgScale * 100;
  bgScaleValue.textContent = Math.round(bgScale * 100) + "%";
  draw();
});
bgScaleIncrease.addEventListener("click", () => {
  bgScale = Math.min(3, bgScale + 0.1);
  bgScaleSlider.value = bgScale * 100;
  bgScaleValue.textContent = Math.round(bgScale * 100) + "%";
  draw();
});

// === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
document.getElementById("saveImageBtn").addEventListener("click", () => {
  const format = document.getElementById("formatSelect").value;
  let width = parseInt(document.getElementById("widthInput").value);
  let height = parseInt(document.getElementById("heightInput").value);
  if (isNaN(width) || width < 100) width = 1920;
  if (isNaN(height) || height < 100) height = 768;

  const tmpCanvas = document.createElement("canvas");
  tmpCanvas.width = width;
  tmpCanvas.height = height;
  const tmpCtx = tmpCanvas.getContext("2d");

  if (bgImage) tmpCtx.drawImage(bgImage, bgPosX, bgPosY, bgImage.width * bgScale, bgImage.height * bgScale);

  images.forEach((imgObj) => {
    tmpCtx.save();
    tmpCtx.translate(
      (imgObj.x / canvas.width) * width + (imgObj.width / 2) * (width / canvas.width),
      (imgObj.y / canvas.height) * height + (imgObj.height / 2) * (height / canvas.height)
    );
    tmpCtx.scale(imgObj.flip ? -1 : 1, 1);
    tmpCtx.drawImage(
      imgObj.img,
      -(imgObj.width / 2) * (width / canvas.width),
      -(imgObj.height / 2) * (height / canvas.height),
      imgObj.width * (width / canvas.width),
      imgObj.height * (height / canvas.height)
    );
    tmpCtx.restore();
  });

  tmpCtx.save();
  tmpCtx.font = "italic 16px cursive";
  tmpCtx.fillStyle = "rgba(255,255,255,0.4)";
  tmpCtx.textAlign = "right";
  tmpCtx.textBaseline = "bottom";
  tmpCtx.fillText("–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–ª–æ–∂–µ–∫ –¥–ª—è –≤–∫", width - 12, height - 8);
  tmpCtx.restore();

  const link = document.createElement("a");
  link.download = "cover." + format;
  link.href = tmpCanvas.toDataURL("image/" + format);
  link.click();
});

// === –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ ===
const helpBtn = document.getElementById("helpBtn");
const helpModal = document.getElementById("helpModal");
const closeBtn = document.querySelector(".modal .close");
const helpVideo = helpModal.querySelector("video");

helpBtn.onclick = () => { helpModal.style.display = "block"; };
closeBtn.onclick = () => { helpModal.style.display = "none"; if (helpVideo) { helpVideo.pause(); helpVideo.currentTime = 0; } };
window.onclick = (e) => { if (e.target === helpModal) { helpModal.style.display = "none"; if (helpVideo) { helpVideo.pause(); helpVideo.currentTime = 0; } } };

draw();
</script>
</body>
</html>
