<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Редактор картинок с VK Bridge</title>
<style>
  body { font-family: Arial,sans-serif; margin:8px; display:flex; flex-direction:column; align-items:center; gap:8px; }
  #canvasWrap { background:#b0b0b0; border-radius:6px; padding:8px; box-shadow:0 0 4px #999; }
  canvas { background:#222; cursor:grab; display:block; border-radius:0px; }
  #controls { width:951px; display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; }
  label { display:block; font-size:13px; margin-bottom:4px; }
  input, button { width:100%; padding:6px; font-size:13px; box-sizing:border-box; }
  button { cursor:pointer; border-radius:4px; border:1px solid #bbb; background:#fff; user-select:none; }
  button.active { background:#2b83ff; color:#fff; }
  .flex-row { display:flex; gap:8px; align-items:center; }
  #controls .flex-row > button { width:auto; min-width:40px; font-weight:bold; }
</style>
</head>
<body>

<h2>Редактор картинок с VK Bridge</h2>

<div class="flex-row" style="gap:16px;">
  <button id="loadBgBtn">Загрузить фон</button>
  <input type="file" id="bgFile" accept="image/*" style="display:none;" />
  <button id="addImg1Btn">Добавить картинку 1</button>
  <input type="file" id="addImgFile1" accept="image/*" style="display:none;" />
  <button id="addImg2Btn">Добавить картинку 2</button>
  <input type="file" id="addImgFile2" accept="image/*" style="display:none;" />
</div>

<div class="flex-row" style="gap:8px;">
  <button id="flipHorizBtn">Перевернуть картинку горизонтально</button>
</div>

<div id="canvasWrap">
  <canvas id="canvas" width="951" height="375"></canvas>
</div>

<div class="flex-row" style="gap:8px; margin-top:8px;">
  <button id="saveJPG">Скачать картинку 1920×768</button>
</div>

<div class="flex-row" style="gap:8px; margin-top:8px;">
  <a href="https://textdrom.com/vintage-text-effect.html" target="_blank">Сделай красивый текст 1</a>
  <a href="https://ru.textstudio.com/" target="_blank">Сделай красивый текст 2</a>
</div>

<p style="font-size:10px; color:#666;">Интерфейс: Придумал, сделал. MUZER play.</p>

<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
(async () => {
  try {
    await vkBridge.send('VKWebAppInit');
    console.log('VK Bridge initialized successfully');
  } catch (e) {
    console.warn('VK Bridge initialization failed or unavailable', e);
  }
})();
</script>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let bgImage = null;
let images = [];
let selectedIndex = -1, dragging = false;
let dragOffsetX = 0, dragOffsetY = 0;

class ImageObject {
  constructor(img, x=0, y=0, scale=1){
    this.img = img;
    this.x = x;
    this.y = y;
    this.scale = scale;
    this.flip = false;
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(bgImage) ctx.drawImage(bgImage,0,0,canvas.width,canvas.height);
  else { ctx.fillStyle='#222'; ctx.fillRect(0,0,canvas.width,canvas.height); }

  images.forEach(imgObj=>{
    ctx.save();
    ctx.translate(imgObj.x + imgObj.img.width*imgObj.scale/2, imgObj.y + imgObj.img.height*imgObj.scale/2);
    if(imgObj.flip) ctx.scale(-1,1);
    ctx.drawImage(imgObj.img,-imgObj.img.width*imgObj.scale/2,-imgObj.img.height*imgObj.scale/2,imgObj.img.width*imgObj.scale,imgObj.img.height*imgObj.scale);
    ctx.restore();
  });
}

function addImage(input){
  const f = input.files[0]; if(!f) return;
  const img = new Image();
  img.onload = () => {
    let scale = Math.min(canvas.width/img.width, canvas.height/img.height, 1);
    images.push(new ImageObject(img,50,50,scale));
    selectedIndex = images.length-1;
    draw();
  };
  img.src = URL.createObjectURL(f);
}

document.getElementById('loadBgBtn').onclick = () => document.getElementById('bgFile').click();
document.getElementById('bgFile').addEventListener('change', (e) => {
  const f = e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = () => { bgImage = img; draw(); };
  img.src = URL.createObjectURL(f);
});

document.getElementById('addImg1Btn').onclick = () => document.getElementById('addImgFile1').click();
document.getElementById('addImg2Btn').onclick = () => document.getElementById('addImgFile2').click();
document.getElementById('addImgFile1').addEventListener('change', (e)=>addImage(e.target));
document.getElementById('addImgFile2').addEventListener('change', (e)=>addImage(e.target));

document.getElementById('flipHorizBtn').onclick = () => {
  if(selectedIndex >= 0){ images[selectedIndex].flip = !images[selectedIndex].flip; draw(); }
};

canvas.addEventListener('mousedown',(e)=>{
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  dragging = false;

  for(let i = images.length-1; i>=0; i--){
    const img = images[i], w=img.img.width*img.scale, h=img.img.height*img.scale;
    if(mouseX >= img.x && mouseX <= img.x + w && mouseY >= img.y && mouseY <= img.y + h){
      selectedIndex = i;
      dragOffsetX = mouseX - img.x;
      dragOffsetY = mouseY - img.y;
      dragging = true;
      draw();
      return;
    }
  }
});

canvas.addEventListener('mousemove',(e)=>{
  if(!dragging) return;
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  if(selectedIndex >= 0){
    images[selectedIndex].x = mouseX - dragOffsetX;
    images[selectedIndex].y = mouseY - dragOffsetY;
    draw();
  }
});
window.addEventListener('mouseup',()=>{ dragging = false; });

document.getElementById('saveJPG').onclick = () => {
  const tmpCanvas = document.createElement('canvas'); tmpCanvas.width=1920; tmpCanvas.height=768;
  const tmpCtx = tmpCanvas.getContext('2d');
  if(bgImage) tmpCtx.drawImage(bgImage,0,0,1920,768); else { tmpCtx.fillStyle='#222'; tmpCtx.fillRect(0,0,1920,768); }

  images.forEach(imgObj=>{
    tmpCtx.save();
    tmpCtx.translate((imgObj.x/canvas.width)*1920 + (imgObj.img.width*imgObj.scale/2)*(1920/canvas.width),
                     (imgObj.y/canvas.height)*768 + (imgObj.img.height*imgObj.scale/2)*(768/canvas.height));
    if(imgObj.flip) tmpCtx.scale(-1,1);
    tmpCtx.drawImage(imgObj.img,
      -(imgObj.img.width*imgObj.scale/2)*(1920/canvas.width),
      -(imgObj.img.height*imgObj.scale/2)*(768/canvas.height),
      (imgObj.img.width*imgObj.scale)*(1920/canvas.width),
      (imgObj.img.height*imgObj.scale)*(768/canvas.height)
    );
    tmpCtx.restore();
  });

  const link = document.createElement('a'); link.download='image.jpg'; link.href=tmpCanvas.toDataURL('image/jpeg'); link.click();
};

draw();
</script>

</body>
</html>
