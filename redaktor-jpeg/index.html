<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Редактор обложек для ВК</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
(async () => { 
    try { 
        await vkBridge.send('VKWebAppInit'); 
        console.log("VK Bridge инициализирован"); 
    } catch(e){ 
        console.warn('VK Bridge init failed', e); 
    } 
})();
</script>

<style>
body {
  margin: 0; padding: 8px; font-family: Arial, sans-serif;
  background: url("https://raw.githubusercontent.com/NEW-nik-1/R-tv/refs/heads/main/redaktor-jpeg/background-vk.jpg") no-repeat center center fixed;
  background-size: cover; color: #e0e0e0; display: flex; justify-content: center;
}
.container {width: 680px; text-align: center;}
h2 {font-size: 16px; margin-bottom: 6px;}
#canvasWrap {padding: 4px; box-shadow: 0 0 4px #999; margin-bottom: 12px; border: 2px solid #ffcc66; border-radius:4px;}
canvas {
  background: #222; cursor: grab;
  width: 640px; height: 252px; border-radius: 4px; border: 2px dashed #ffcc66;
}
.flex-row, .links-buttons {
  display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 12px;
}
button, .icon-btn {
  font-size: 11px; padding: 6px 12px; border-radius: 4px;
  cursor: pointer; display: flex; align-items: center; gap: 4px;
  transition: all 0.2s ease;
}
button:hover, .icon-btn:hover {
  background-color: #bdb76b; color: #fff; transform: scale(1.05); box-shadow: 0 0 6px rgba(0,0,0,0.4);
}
#scaleControl { width: 640px; display: none; margin-bottom: 12px; justify-content: center; align-items: center; }
.slider-wrapper { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.author-label { font-size: 11px; color: rgba(180,180,180,0.4); text-decoration: none; display: inline-block; padding: 3px 6px; background: #222; border-radius: 4px; margin-top: 60px; }
#smoothingToggleLabel { font-size: 12px; margin-left: 12px; user-select: none; align-items: center; display: flex; gap: 6px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
.modal-content {
  background-color: #222; margin: 6% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 640px; color: #ddd; font-size: 14px; line-height: 1.5; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: left; display: flex; flex-direction: column; gap: 12px;
}
.modal-content h2 { margin-top: 0; color: #ffcc66; text-align: center; }
.close { color: #aaa; align-self: flex-end; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover {color: #fff;}
video {
  width: 100%;
  border-radius: 4px;
  background-color: black;
}
</style>
</head>
<body>
<div class="container">
  <h2>Редактор обложек для ВК</h2>

  <div class="flex-row">
    <button id="loadBgBtn"><i class="fa-solid fa-image"></i> Загрузить фон</button>
    <input type="file" id="bgFile" accept="image/*" style="display:none;" />
    <button id="addImg1Btn"><i class="fa-solid fa-photo-film"></i> Картинка 1</button>
    <input type="file" id="addImgFile1" accept="image/*" style="display:none;" />
    <button id="addImg2Btn"><i class="fa-solid fa-photo-film"></i> Картинка 2</button>
    <input type="file" id="addImgFile2" accept="image/*" style="display:none;" />
    <button id="helpBtn"><i class="fa-solid fa-circle-question"></i> Инструкция</button>
  </div>

  <div id="canvasWrap"><canvas id="canvas" width="640" height="252"></canvas></div>

  <div class="flex-row" style="justify-content:center; margin-bottom:12px;">
    <label style="font-size:12px;">Масштаб фона:</label>
    <button id="bgScaleDecrease" style="font-size:16px;">−</button>
    <input type="range" id="bgScaleSlider" min="50" max="300" value="100" style="width:180px;" />
    <button id="bgScaleIncrease" style="font-size:16px;">+</button>
    <span id="bgScaleValue">100%</span>
  </div>

  <div id="scaleControl">
    <label style="font-size:12px;">Размер выбранной картинки (px)</label>
    <div class="slider-wrapper">
      <div class="icon-btn" id="decrease">−</div>
      <input type="range" id="scaleSlider" min="50" max="500" step="1" value="200" />
      <div class="icon-btn" id="increase">+</div>
      <span id="scaleValue">200</span>
      <label style="display:flex; align-items:center; gap:4px; font-size:12px; margin-left:8px;">
        <input type="checkbox" id="flipHoriz" /> <i class="fa-solid fa-arrows-left-right"></i> Перевернуть горизонтально
      </label>
    </div>
  </div>

  <label id="smoothingToggleLabel">
    <input type="checkbox" id="toggleSmoothing" checked /> Включить сглаживание краёв
  </label>

  <div class="flex-row">
    <select id="formatSelect">
      <option value="jpeg">JPG</option>
      <option value="png">PNG</option>
    </select>
    <input type="number" id="widthInput" value="1920" min="100" style="width:60px;" /> ×
    <input type="number" id="heightInput" value="768" min="100" style="width:60px;" />
    <button id="saveImageBtn"><i class="fa-solid fa-download"></i> Скачать</button>
  </div>

  <div class="links-buttons">
    <button onclick="window.open('https://www.photoroom.com/ru/instrumenty/ubrat-fon-onlayn', '_blank')"><i class="fa-solid fa-scissors"></i> Убрать фон (Photoroom)</button>
    <button onclick="window.open('https://carve.photos/', '_blank')"><i class="fa-solid fa-cut"></i> Убрать фон (Carve.photos)</button>
    <button onclick="window.open('https://ru.textstudio.com/', '_blank')"><i class="fa-solid fa-font"></i> Красивый текст (TextStudio)</button>
    <button onclick="window.open('https://textdrom.com/vintage-text-effect.html', '_blank')"><i class="fa-solid fa-font"></i> Красивый текст (TextDrom)</button>
  </div>

  <div><a class="author-label" href="https://vk.com/muzer_play" target="_blank"><i class="fa-solid fa-user"></i> Автор: MUZER play + ( ChatGPT )</a></div>
</div>

<!-- Модальное окно инструкции с видео -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2>Инструкция по использованию редактора</h2>
    <video controls>
      <source src="your-video-file.mp4" type="video/mp4" />
      Ваш браузер не поддерживает просмотр видео.
    </video>
    <ol>
      <li>Загрузка фона</li>
      <li>Добавление картинок</li>
      <li>Перемещение, масштабирование, переворот</li>
      <li>Удаление правым кликом</li>
      <li>Сохранение видимой области</li>
    </ol>
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let bgImage = null;
let images = [];
let selectedIndex = -1;
let dragging = false;
let dragOffsetX = 0, dragOffsetY = 0;
let lastOffsetX = 40, lastOffsetY = 40;
let smoothingEnabled = true;
let bgScale = 1.0;
let bgPosX = 0, bgPosY = 0;
let draggingBg = false, dragStartX = 0, dragStartY = 0;

const scaleControl = document.getElementById("scaleControl");
const scaleSlider = document.getElementById("scaleSlider");
const scaleValue = document.getElementById("scaleValue");
const decreaseBtn = document.getElementById("decrease");
const increaseBtn = document.getElementById("increase");
const flipCheckbox = document.getElementById("flipHoriz");
const bgScaleSlider = document.getElementById("bgScaleSlider");
const bgScaleValue = document.getElementById("bgScaleValue");
const bgScaleDecrease = document.getElementById("bgScaleDecrease");
const bgScaleIncrease = document.getElementById("bgScaleIncrease");

class ImageObject {
    constructor(img, x=0, y=0) {
        this.img = img;
        this.x = x;
        this.y = y;
        this.width = 200;
        this.height = (200*img.height)/img.width;
        this.flip = false;
    }
}

function drawImageWithSmoothEdges(ctx, imgObj) {
    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width = imgObj.width;
    tmpCanvas.height = imgObj.height;
    const tmpCtx = tmpCanvas.getContext("2d");
    tmpCtx.imageSmoothingEnabled = smoothingEnabled;
    tmpCtx.imageSmoothingQuality = smoothingEnabled ? "high" : "low";
    tmpCtx.clearRect(0,0,tmpCanvas.width,tmpCanvas.height);
    tmpCtx.drawImage(imgObj.img,0,0,imgObj.width,imgObj.height);
    if(smoothingEnabled){
        let gradient = tmpCtx.createLinearGradient(0,0,tmpCanvas.width,0);
        const fadeWidth = Math.min(30,tmpCanvas.width/4);
        gradient.addColorStop(0,"rgba(0,0,0,0)");
        gradient.addColorStop(fadeWidth/tmpCanvas.width,"rgba(0,0,0,1)");
        gradient.addColorStop(1-fadeWidth/tmpCanvas.width,"rgba(0,0,0,1)");
        gradient.addColorStop(1,"rgba(0,0,0,0)");
        tmpCtx.globalCompositeOperation = "destination-in";
        tmpCtx.fillStyle = gradient;
        tmpCtx.fillRect(0,0,tmpCanvas.width,tmpCanvas.height);
        tmpCtx.globalCompositeOperation = "source-over";
    }
    ctx.save();
    ctx.translate(imgObj.x + imgObj.width/2, imgObj.y + imgObj.height/2);
    ctx.scale(imgObj.flip ? -1 : 1, 1);
    ctx.drawImage(tmpCanvas,-imgObj.width/2,-imgObj.height/2);
    ctx.restore();
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(bgImage){
        const w = bgImage.width*bgScale;
        const h = bgImage.height*bgScale;
        ctx.drawImage(bgImage,bgPosX,bgPosY,w,h);
    }
    images.forEach(img=>drawImageWithSmoothEdges(ctx,img));
}

function addImage(input){
    const f = input.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=>{
        lastOffsetX+=20; lastOffsetY+=20;
        if(lastOffsetX>canvas.width-200) lastOffsetX=40;
        if(lastOffsetY>canvas.height-200) lastOffsetY=40;
        const obj = new ImageObject(img,lastOffsetX,lastOffsetY);
        images.push(obj); selectedIndex=images.length-1;
        updateScaleControl(obj); draw();
    }
    img.src = URL.createObjectURL(f);
    input.value="";
}

function updateScaleControl(imgObj){
    scaleSlider.value=imgObj.width;
    scaleValue.textContent=imgObj.width;
    flipCheckbox.checked=imgObj.flip;
    scaleControl.style.display="flex";
}

// --- Загрузка ---
document.getElementById("loadBgBtn").onclick = ()=>document.getElementById("bgFile").click();
document.getElementById("bgFile").addEventListener("change",e=>{
    const f=e.target.files[0]; if(!f) return;
    const img = new Image();
    img.onload = ()=>{
        bgImage=img;
        bgPosX=(canvas.width-bgImage.width)/2;
        bgPosY=(canvas.height-bgImage.height)/2;
        bgScale=1.0;
        bgScaleSlider.value=100; bgScaleValue.textContent="100%";
        draw();
    }
    img.src=URL.createObjectURL(f);
});
document.getElementById("addImg1Btn").onclick = ()=>document.getElementById("addImgFile1").click();
document.getElementById("addImg2Btn").onclick = ()=>document.getElementById("addImgFile2").click();
document.getElementById("addImgFile1").addEventListener("change",e=>addImage(e.target));
document.getElementById("addImgFile2").addEventListener("change",e=>addImage(e.target));

// --- Перетаскивание ---
canvas.addEventListener("mousedown",e=>{
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX-rect.left;
    const mouseY = e.clientY-rect.top;
    dragging=false;
    for(let i=images.length-1;i>=0;i--){
        const img=images[i];
        if(mouseX>=img.x && mouseX<=img.x+img.width && mouseY>=img.y && mouseY<=img.y+img.height){
            selectedIndex=i; dragOffsetX=mouseX-img.x; dragOffsetY=mouseY-img.y;
            dragging=true; updateScaleControl(img); draw(); return;
        }
    }
    if(bgImage){
        const w=bgImage.width*bgScale; const h=bgImage.height*bgScale;
        if(mouseX>=bgPosX && mouseX<=bgPosX+w && mouseY>=bgPosY && mouseY<=bgPosY+h){
            draggingBg=true; dragStartX=mouseX-bgPosX; dragStartY=mouseY-bgPosY;
            return;
        }
    }
});
canvas.addEventListener("mousemove",e=>{
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX-rect.left;
    const mouseY = e.clientY-rect.top;
    if(draggingBg){ bgPosX=mouseX-dragStartX; bgPosY=mouseY-dragStartY; draw(); }
    else if(dragging && selectedIndex>=0){ 
        images[selectedIndex].x=mouseX-dragOffsetX; images[selectedIndex].y=mouseY-dragOffsetY; draw(); 
    }
});
window.addEventListener("mouseup",()=>{ dragging=false; draggingBg=false; });

// --- Удаление ---
canvas.addEventListener("contextmenu",e=>{
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const mouseX=e.clientX-rect.left;
    const mouseY=e.clientY-rect.top;
    for(let i=images.length-1;i>=0;i--){
        const img=images[i];
        if(mouseX>=img.x && mouseX<=img.x+img.width && mouseY>=img.y && mouseY<=img.y+img.height){
            images.splice(i,1);
            if(images.length>0){ selectedIndex=images.length-1; updateScaleControl(images[selectedIndex]); }
            else { selectedIndex=-1; scaleControl.style.display="none"; }
            draw(); return;
        }
    }
});

// --- Масштаб и переворот ---
function updateImageSize(width){
    if(selectedIndex>=0){
        const imgObj=images[selectedIndex];
        imgObj.width=width; imgObj.height=(width*imgObj.img.height)/imgObj.img.width;
        scaleSlider.value=width; scaleValue.textContent=width; draw();
    }
}
scaleSlider.addEventListener("input",()=>updateImageSize(parseInt(scaleSlider.value)));
decreaseBtn.addEventListener("click",()=>updateImageSize(Math.max(50,parseInt(scaleSlider.value)-10)));
increaseBtn.addEventListener("click",()=>updateImageSize(Math.min(500,parseInt(scaleSlider.value)+10)));
flipCheckbox.addEventListener("change",()=>{ if(selectedIndex>=0){ images[selectedIndex].flip=flipCheckbox.checked; draw(); }});
document.getElementById("toggleSmoothing").addEventListener("change",()=>{ smoothingEnabled=document.getElementById("toggleSmoothing").checked; draw(); });

// --- Масштаб фона ---
bgScaleSlider.addEventListener("input",()=>{ bgScale=bgScaleSlider.value/100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw(); });
bgScaleDecrease.addEventListener("click",()=>{ bgScale=Math.max(0.5,bgScale-0.1); bgScaleSlider.value=bgScale*100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw(); });
bgScaleIncrease.addEventListener("click",()=>{ bgScale=Math.min(5,bgScale+0.1); bgScaleSlider.value=bgScale*100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw(); });

// --- Сохранение ---
document.getElementById("saveImageBtn").addEventListener("click",()=>{
    const width = parseInt(document.getElementById("widthInput").value);
    const height = parseInt(document.getElementById("heightInput").value);
    const format = document.getElementById("formatSelect").value;
    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width=width;
    tmpCanvas.height=height;
    const tmpCtx = tmpCanvas.getContext("2d");
    tmpCtx.imageSmoothingEnabled = smoothingEnabled;
    tmpCtx.imageSmoothingQuality = smoothingEnabled ? "high" : "low";
    tmpCtx.drawImage(canvas, 0, 0, width, height);

    // Добавляем белый полупрозрачный водяной знак внизу справа
    const text = ".Редактор обложек для вк.";
    tmpCtx.font = "20px Arial";
    tmpCtx.fillStyle = "rgba(255, 255, 255, 0.2)"; // прозрачный белый текст
    tmpCtx.textAlign = "right";
    tmpCtx.textBaseline = "bottom";
    tmpCtx.fillText(text, width - 10, height - 10);

    tmpCanvas.toBlob(blob=>{
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "cover."+format;
        a.click();
    }, "image/"+format);
});

// --- Модалка инструкции ---
const modal = document.getElementById("helpModal");
const helpBtn = document.getElementById("helpBtn");
const closeSpan = document.getElementById("closeModal");
const video = modal.querySelector("video");

function closeModalFunction(){
  modal.style.display = "none";
  video.pause();
  video.currentTime = 0;
}

helpBtn.onclick = () => { modal.style.display = "block"; };
closeSpan.onclick = closeModalFunction;
window.onclick = e => { if (e.target === modal) closeModalFunction(); };

draw();
</script>
</body>
</html>
