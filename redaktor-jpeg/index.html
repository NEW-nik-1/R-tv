<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–ª–æ–∂–µ–∫ –¥–ª—è –í–ö</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
/* ========== –ß–ê–°–¢–¨ 1: –°–¢–ò–õ–ò ========== */
body {
  margin: 0; padding: 8px; font-family: Arial, sans-serif;
  background: #111; color: #e0e0e0; display: flex; justify-content: center;
}
.container {width: 680px; text-align: center;}
h2 {font-size: 16px; margin-bottom: 6px;}
#canvasWrap {padding: 4px; box-shadow: 0 0 4px #999; margin-bottom: 12px;}
canvas {
  background: #222; cursor: grab;
  width: 640px; height: 252px; border-radius: 4px;
}
.flex-row, .links-buttons {
  display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; align-items: center; margin-bottom: 12px;
}
button, .icon-btn {
  font-size: 11px; padding: 6px 12px; border-radius: 4px;
  cursor: pointer; display: flex; align-items: center; gap: 4px;
  transition: all 0.2s ease;
}
button:hover, .icon-btn:hover {
  background-color: #bdb76b; color: #fff; transform: scale(1.05); box-shadow: 0 0 6px rgba(0,0,0,0.4);
}
#scaleControl {
  width: 640px; display: none; margin-bottom: 12px; justify-content: center; align-items: center;
}
.slider-wrapper {
  display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
.author-label {
  font-size: 11px; color: rgba(180,180,180,0.4); text-decoration: none;
  display: inline-block; padding: 3px 6px; background: #222; border-radius: 4px; margin-top: 60px;
}
#smoothingToggleLabel {
  font-size: 12px; margin-left: 12px; user-select: none; align-items: center; display: flex; gap: 6px;
}
.modal {
  display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);
}
.modal-content {
  background-color: #222; margin: 6% auto; padding: 20px; border-radius: 8px;
  width: 80%; max-width: 640px; color: #ddd; font-size: 14px; line-height: 1.5;
  box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: left;
}
.modal-content h2 {
  margin-top: 0; color: #ffcc66;
}
.close {
  color: #aaa; float: right; font-size: 22px; font-weight: bold; cursor: pointer;
}
.close:hover {color: #fff;}
</style>
</head>
<body>
<div class="container">
  <h2>–†–µ–¥–∞–∫—Ç–æ—Ä –æ–±–ª–æ–∂–µ–∫ –¥–ª—è –í–ö</h2>

  <div class="flex-row">
    <button id="loadBgBtn"><i class="fa-solid fa-image"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω</button>
    <input type="file" id="bgFile" accept="image/*" style="display:none;" />
    <button id="addImg1Btn"><i class="fa-solid fa-photo-film"></i> –ö–∞—Ä—Ç–∏–Ω–∫–∞ 1</button>
    <input type="file" id="addImgFile1" accept="image/*" style="display:none;" />
    <button id="addImg2Btn"><i class="fa-solid fa-photo-film"></i> –ö–∞—Ä—Ç–∏–Ω–∫–∞ 2</button>
    <input type="file" id="addImgFile2" accept="image/*" style="display:none;" />
    <button id="helpBtn"><i class="fa-solid fa-circle-question"></i> –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
  </div>

  <div id="canvasWrap"><canvas id="canvas" width="640" height="252"></canvas></div>

  <div class="flex-row" style="justify-content:center; margin-bottom:12px;">
    <label style="font-size:12px;">–ú–∞—Å—à—Ç–∞–± —Ñ–æ–Ω–∞:</label>
    <button id="bgScaleDecrease" style="font-size:16px;">‚àí</button>
    <input type="range" id="bgScaleSlider" min="50" max="300" value="100" style="width:180px;" />
    <button id="bgScaleIncrease" style="font-size:16px;">+</button>
    <span id="bgScaleValue">100%</span>
  </div>

  <div id="scaleControl">
    <label style="font-size:12px;">–†–∞–∑–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ (px)</label>
    <div class="slider-wrapper">
      <div class="icon-btn" id="decrease">‚àí</div>
      <input type="range" id="scaleSlider" min="50" max="500" step="1" value="200" />
      <div class="icon-btn" id="increase">+</div>
      <span id="scaleValue">200</span>
      <label style="display:flex; align-items:center; gap:4px; font-size:12px; margin-left:8px;">
        <input type="checkbox" id="flipHoriz" /> <i class="fa-solid fa-arrows-left-right"></i> –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
      </label>
    </div>
  </div>

  <label id="smoothingToggleLabel">
    <input type="checkbox" id="toggleSmoothing" checked />
    –í–∫–ª—é—á–∏—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–∞—ë–≤
  </label>

  <div class="flex-row">
    <select id="formatSelect">
      <option value="jpeg">JPG</option>
      <option value="png">PNG</option>
    </select>
    <input type="number" id="widthInput" value="1920" min="100" style="width:60px;" /> √ó
    <input type="number" id="heightInput" value="768" min="100" style="width:60px;" />
    <button id="saveImageBtn"><i class="fa-solid fa-download"></i> –°–∫–∞—á–∞—Ç—å</button>
  </div>

  <div class="links-buttons">
    <button onclick="window.open('https://www.photoroom.com/ru/instrumenty/ubrat-fon-onlayn', '_blank')"><i class="fa-solid fa-scissors"></i> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω (Photoroom)</button>
    <button onclick="window.open('https://carve.photos/', '_blank')"><i class="fa-solid fa-cut"></i> –£–±—Ä–∞—Ç—å —Ñ–æ–Ω (Carve.photos)</button>
    <button onclick="window.open('https://ru.textstudio.com/', '_blank')"><i class="fa-solid fa-font"></i> –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç (TextStudio)</button>
    <button onclick="window.open('https://textdrom.com/vintage-text-effect.html', '_blank')"><i class="fa-solid fa-font"></i> –ö—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç (TextDrom)</button>
  </div>

  <div><a class="author-label" href="https://vk.com/muzer_play" target="_blank"><i class="fa-solid fa-user"></i> –ê–≤—Ç–æ—Ä: MUZER play + ( ChatGPT )</a></div>
</div>

<div id="helpModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>üìò –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –æ–±–ª–æ–∂–µ–∫</h2>
    <ol>
      <li>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ –∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ.</li>
      <li>–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ ‚Äî —É–¥–∞–ª–∏—Ç—å –µ—ë.</li>
      <li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –æ–±–ª–∞—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º.</li>
    </ol>
  </div>
</div>

<script>
/* ========== –ß–ê–°–¢–¨ 2: JS ========== */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let bgImage = null, images = [], selectedIndex = -1;
let dragging = false, draggingBg = false, dragOffsetX=0, dragOffsetY=0, dragStartX=0, dragStartY=0;
let smoothingEnabled = true, bgScale = 1.0, bgPosX = 0, bgPosY = 0;
let lastOffsetX=40, lastOffsetY=40;

const scaleControl = document.getElementById("scaleControl");
const scaleSlider = document.getElementById("scaleSlider");
const scaleValue = document.getElementById("scaleValue");
const decreaseBtn = document.getElementById("decrease");
const increaseBtn = document.getElementById("increase");
const flipHoriz = document.getElementById("flipHoriz");
const bgScaleSlider = document.getElementById("bgScaleSlider");
const bgScaleValue = document.getElementById("bgScaleValue");
const bgScaleDecrease = document.getElementById("bgScaleDecrease");
const bgScaleIncrease = document.getElementById("bgScaleIncrease");
const helpBtn = document.getElementById("helpBtn");
const helpModal = document.getElementById("helpModal");
const closeBtn = document.querySelector(".modal .close");

class ImageObject {
  constructor(img,x=0,y=0){
    this.img=img; this.x=x; this.y=y;
    this.width=200; this.height=(200*img.height)/img.width;
    this.flip=false;
  }
}

function drawImageWithSmoothEdges(ctx,imgObj){
  const tmpCanvas=document.createElement("canvas");
  tmpCanvas.width=imgObj.width; tmpCanvas.height=imgObj.height;
  const tmpCtx=tmpCanvas.getContext("2d");
  tmpCtx.imageSmoothingEnabled=smoothingEnabled;
  tmpCtx.clearRect(0,0,tmpCanvas.width,tmpCanvas.height);
  tmpCtx.drawImage(imgObj.img,0,0,imgObj.width,imgObj.height);
  ctx.save();
  ctx.translate(imgObj.x+imgObj.width/2,imgObj.y+imgObj.height/2);
  ctx.scale(imgObj.flip?-1:1,1);
  ctx.drawImage(tmpCanvas,-imgObj.width/2,-imgObj.height/2);
  ctx.restore();
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(bgImage) ctx.drawImage(bgImage,bgPosX,bgPosY,bgImage.width*bgScale,bgImage.height*bgScale);
  images.forEach(img=>drawImageWithSmoothEdges(ctx,img));
}

// ====== –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ ======
document.getElementById("loadBgBtn").onclick = ()=> document.getElementById("bgFile").click();
document.getElementById("bgFile").addEventListener("change",(e)=>{
  const f=e.target.files[0];
  if(!f) return;
  const img=new Image();
  img.onload=()=>{
    bgImage=img;
    bgPosX=(canvas.width-bgImage.width)/2;
    bgPosY=(canvas.height-bgImage.height)/2;
    bgScale=1.0;
    bgScaleSlider.value=100;
    bgScaleValue.textContent="100%";
    draw();
  };
  img.src=URL.createObjectURL(f);
});

// ====== –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ ======
function addImage(input){
  const f=input.files[0]; if(!f) return;
  const img=new Image();
  img.onload=()=>{
    lastOffsetX+=20; lastOffsetY+=20;
    if(lastOffsetX>canvas.width-200) lastOffsetX=40;
    if(lastOffsetY>canvas.height-200) lastOffsetY=40;
    const imgObj=new ImageObject(img,lastOffsetX,lastOffsetY);
    images.push(imgObj);
    selectedIndex=images.length-1;
    scaleControl.style.display="flex";
    scaleSlider.value=imgObj.width;
    scaleValue.textContent=imgObj.width;
    flipHoriz.checked=imgObj.flip;
    draw();
  };
  img.src=URL.createObjectURL(f);
  input.value="";
}
document.getElementById("addImg1Btn").onclick=()=>document.getElementById("addImgFile1").click();
document.getElementById("addImg2Btn").onclick=()=>document.getElementById("addImgFile2").click();
document.getElementById("addImgFile1").addEventListener("change",(e)=>addImage(e.target));
document.getElementById("addImgFile2").addEventListener("change",(e)=>addImage(e.target));

// ====== –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ ======
canvas.addEventListener("mousedown",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const mouseX=e.clientX-rect.left, mouseY=e.clientY-rect.top;
  dragging=false; draggingBg=false;

  for(let i=images.length-1;i>=0;i--){
    const img=images[i];
    if(mouseX>=img.x && mouseX<=img.x+img.width && mouseY>=img.y && mouseY<=img.y+img.height){
      selectedIndex=i;
      dragOffsetX=mouseX-img.x;
      dragOffsetY=mouseY-img.y;
      dragging=true;
      scaleSlider.value=img.width; scaleValue.textContent=img.width; flipHoriz.checked=img.flip;
      draw();
      return;
    }
  }
  if(bgImage){
    const scaledWidth=bgImage.width*bgScale, scaledHeight=bgImage.height*bgScale;
    if(mouseX>=bgPosX && mouseX<=bgPosX+scaledWidth && mouseY>=bgPosY && mouseY<=bgPosY+scaledHeight){
      draggingBg=true;
      dragStartX=mouseX-bgPosX;
      dragStartY=mouseY-bgPosY;
      return;
    }
  }
});

canvas.addEventListener("mousemove",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const mouseX=e.clientX-rect.left, mouseY=e.clientY-rect.top;
  if(dragging && selectedIndex>=0){
    images[selectedIndex].x=mouseX-dragOffsetX;
    images[selectedIndex].y=mouseY-dragOffsetY;
    draw();
  } else if(draggingBg){
    bgPosX=mouseX-dragStartX;
    bgPosY=mouseY-dragStartY;
    draw();
  }
});

window.addEventListener("mouseup",()=>{dragging=false; draggingBg=false;});

// ====== –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤—ã–º –∫–ª–∏–∫–æ–º ======
canvas.addEventListener("contextmenu",(e)=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const mouseX=e.clientX-rect.left, mouseY=e.clientY-rect.top;
  for(let i=images.length-1;i>=0;i--){
    const img=images[i];
    if(mouseX>=img.x && mouseX<=img.x+img.width && mouseY>=img.y && mouseY<=img.y+img.height){
      images.splice(i,1);
      if(images.length>0){ selectedIndex=images.length-1; scaleSlider.value=images[selectedIndex].width; scaleValue.textContent=images[selectedIndex].width; flipHoriz.checked=images[selectedIndex].flip;}
      else {selectedIndex=-1; scaleControl.style.display="none";}
      draw();
      return;
    }
  }
});

// ====== –ú–∞—Å—à—Ç–∞–± –∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ ======
function updateImageSize(width){
  if(selectedIndex>=0){
    const imgObj=images[selectedIndex];
    imgObj.width=width;
    imgObj.height=(width*imgObj.img.height)/imgObj.img.width;
    scaleSlider.value=width;
    scaleValue.textContent=width;
    draw();
  }
}
scaleSlider.addEventListener("input",()=>updateImageSize(parseInt(scaleSlider.value)));
decreaseBtn.addEventListener("click",()=>updateImageSize(Math.max(50,parseInt(scaleSlider.value)-10)));
increaseBtn.addEventListener("click",()=>updateImageSize(Math.min(500,parseInt(scaleSlider.value)+10)));
flipHoriz.addEventListener("change",()=>{if(selectedIndex>=0){images[selectedIndex].flip=flipHoriz.checked; draw();}});

// ====== –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ ======
document.getElementById("toggleSmoothing").addEventListener("change",(e)=>{smoothingEnabled=e.target.checked; draw();});

// ====== –ú–∞—Å—à—Ç–∞–± —Ñ–æ–Ω–∞ ======
bgScaleSlider.addEventListener("input",()=>{bgScale=bgScaleSlider.value/100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw();});
bgScaleDecrease.addEventListener("click",()=>{bgScale=Math.max(0.5,bgScale-0.1); bgScaleSlider.value=bgScale*100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw();});
bgScaleIncrease.addEventListener("click",()=>{bgScale=Math.min(3,bgScale+0.1); bgScaleSlider.value=bgScale*100; bgScaleValue.textContent=Math.round(bgScale*100)+"%"; draw();});

// ====== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ======
document.getElementById("saveImageBtn").onclick=()=>{
  const format=document.getElementById("formatSelect").value;
  let width=parseInt(document.getElementById("widthInput").value);
  let height=parseInt(document.getElementById("heightInput").value);
  if(isNaN(width)||width<100) width=1920;
  if(isNaN(height)||height<100) height=768;

  const tmpCanvas=document.createElement("canvas");
  tmpCanvas.width=width; tmpCanvas.height=height;
  const tmpCtx=tmpCanvas.getContext("2d");

  if(bgImage) tmpCtx.drawImage(bgImage,bgPosX/bgScale*width/canvas.width,bgPosY/bgScale*height/canvas.height,bgImage.width*width/canvas.width,bgImage.height*height/canvas.height);

  images.forEach(img=>{
    const scaleX=width/canvas.width, scaleY=height/canvas.height;
    tmpCtx.save();
    tmpCtx.translate((img.x+img.width/2)*scaleX,(img.y+img.height/2)*scaleY);
    tmpCtx.scale(img.flip?-1:1,1);
    tmpCtx.imageSmoothingEnabled=smoothingEnabled;
    tmpCtx.drawImage(img.img,-img.width/2*scaleX,-img.height/2*scaleY,img.width*scaleX,img.height*scaleY);
    tmpCtx.restore();
  });

  tmpCanvas.toBlob(blob=>{
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="cover."+format;
    link.click();
  },'image/'+format);
};

// ====== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–º–æ—â–∏ ======
helpBtn.onclick=()=>{helpModal.style.display="block";};
closeBtn.onclick=()=>{helpModal.style.display="none";};
window.onclick=(e)=>{if(e.target==helpModal) helpModal.style.display="none";}
</script>
</body>
</html>
