<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<script>
let audioList = [];
let currentTrackIndex = 0;
let audio = new Audio();

const playerDiv = document.getElementById('player');
const playPauseBtn = document.getElementById('playPause');
const progress = document.getElementById('progress');
const progressContainer = document.getElementById('progressContainer');

(async () => {
  try {
    await vkBridge.send('VKWebAppInit');
    // Пробуем автоматическую авторизацию
    const auth = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: 54292239, // замените на свой App ID
      scope: 'audio'
    });

    if(auth.access_token) {
      console.log('Автоавторизация успешна');
      document.getElementById('login').style.display = 'none'; // скрываем кнопку
      await loadAudio(auth.access_token);
    } else {
      console.log('Пользователь не авторизован, нужна кнопка входа');
      document.getElementById('login').style.display = 'block';
    }
  } catch(e) {
    console.warn('Автоавторизация невозможна', e);
    document.getElementById('login').style.display = 'block';
  }
})();

// Функция загрузки аудио
async function loadAudio(token) {
  try {
    const resp = await vkBridge.send('VKWebAppCallAPIMethod', {
      method: 'audio.get',
      params: {
        access_token: token,
        v: '5.131',
        count: 20
      }
    });
    if(resp.response && resp.response.items.length > 0) {
      audioList = resp.response.items;
      currentTrackIndex = 0;
      playTrack(currentTrackIndex);
    } else {
      alert('Нет аудиозаписей или доступ запрещен');
    }
  } catch(e) {
    console.error('Ошибка получения аудио', e);
  }
}

// Рендер треков
function renderTracks() {
  playerDiv.innerHTML = '';
  audioList.forEach((track, i) => {
    const trackDiv = document.createElement('div');
    trackDiv.className = 'track' + (i === currentTrackIndex ? ' active' : '');
    trackDiv.onclick = () => {
      currentTrackIndex = i;
      playTrack(currentTrackIndex);
    };

    const img = document.createElement('img');
    img.src = track.album?.thumb?.src || track.thumb?.photo_50 || 'https://vk.com/images/deactivated_200.png';
    trackDiv.appendChild(img);

    const info = document.createElement('div');
    info.className = 'track-info';
    const title = document.createElement('p');
    title.textContent = track.artist + ' - ' + track.title;
    info.appendChild(title);
    trackDiv.appendChild(info);

    playerDiv.appendChild(trackDiv);
  });

  const activeTrack = playerDiv.querySelector('.track.active');
  if(activeTrack) activeTrack.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Проигрывание трека
function playTrack(index) {
  if(!audioList[index]) return;
  audio.src = audioList[index].url;
  audio.play().catch(e => console.warn('Ошибка воспроизведения', e));
  renderTracks();
}

// Управление треками
document.getElementById('prev').onclick = () => {
  currentTrackIndex = (currentTrackIndex - 1 + audioList.length) % audioList.length;
  playTrack(currentTrackIndex);
};
document.getElementById('next').onclick = () => {
  currentTrackIndex = (currentTrackIndex + 1) % audioList.length;
  playTrack(currentTrackIndex);
};
playPauseBtn.onclick = () => {
  if(audio.paused) audio.play();
  else audio.pause();
};
audio.addEventListener('play', () => playPauseBtn.textContent = '⏸️');
audio.addEventListener('pause', () => playPauseBtn.textContent = '▶️');
audio.addEventListener('ended', () => {
  currentTrackIndex = (currentTrackIndex + 1) % audioList.length;
  playTrack(currentTrackIndex);
});
audio.addEventListener('timeupdate', () => {
  const percent = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
  progress.style.width = percent + '%';
});
progressContainer.onclick = (e) => {
  const rect = progressContainer.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const width = rect.width;
  audio.currentTime = (clickX / width) * audio.duration;
};

// Кнопка ручного входа (если автоавторизация не сработала)
document.getElementById('login').onclick = async () => {
  try {
    const auth = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: YOUR_APP_ID,
      scope: 'audio'
    });
    if(auth.access_token) {
      document.getElementById('login').style.display = 'none';
      await loadAudio(auth.access_token);
    }
  } catch(e) {
    console.error(e);
    alert('Ошибка авторизации');
  }
};
</script>
