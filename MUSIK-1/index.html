<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>VK Mini App - Поиск песен с модальным окном</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #playlist div { padding: 5px; cursor: pointer; border-bottom: 1px solid #ccc; }
  #playlist div:hover { background: #f0f0f0; }
  #playlist .active { font-weight: bold; background: #ddd; }
  button { padding: 8px 12px; font-size: 16px; }
  /* Модальное окно */
  #modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }
  #modalContent {
    background: white;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    border-radius: 8px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
  }
  #searchResults {
    overflow-y: auto;
    max-height: 300px;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
  }
  #searchResults div {
    padding: 8px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }
  #searchResults div:hover {
    background-color: #f2f2f2;
  }
  #closeModal {
    align-self: flex-end;
    cursor: pointer;
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
  }
</style>
</head>
<body>

<h2>VK Mini App - Аудиоплеер</h2>
<button id="openSearch">Поиск песен</button>

<h3>Плейлист:</h3>
<div id="playlist"></div>

<audio id="audioPlayer" controls style="width: 100%; margin-top: 15px;"></audio>

<!-- Модальное окно -->
<div id="modal">
  <div id="modalContent">
    <div id="closeModal">✖</div>
    <input type="text" id="searchInput" placeholder="Введите название певца или песни" />
    <button id="searchBtn">Поиск</button>
    <div id="searchResults"></div>
  </div>
</div>

<script>
const vkBridge = window.vkBridge;

const openSearchBtn = document.getElementById('openSearch');
const modal = document.getElementById('modal');
const closeModalBtn = document.getElementById('closeModal');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const searchResultsDiv = document.getElementById('searchResults');
const playlistDiv = document.getElementById('playlist');
const audioPlayer = document.getElementById('audioPlayer');

let playlist = [];
let currentTrackIndex = -1;

function renderPlaylist() {
  playlistDiv.innerHTML = '';
  playlist.forEach((track, idx) => {
    const div = document.createElement('div');
    div.textContent = `${track.artist} — ${track.title}`;
    div.className = (idx === currentTrackIndex) ? 'active' : '';
    div.onclick = () => playTrack(idx);
    playlistDiv.appendChild(div);
  });
}

function playTrack(index) {
  if (index < 0 || index >= playlist.length) return;
  currentTrackIndex = index;
  audioPlayer.src = playlist[index].url;
  audioPlayer.play();
  renderPlaylist();
}

audioPlayer.onended = () => {
  let next = currentTrackIndex + 1;
  if (next >= playlist.length) next = 0;
  playTrack(next);
};

// Открыть модальное окно поиска
openSearchBtn.onclick = () => {
  modal.style.display = 'flex';
  searchInput.value = '';
  searchResultsDiv.innerHTML = '';
  searchInput.focus();
};

// Закрыть модальное окно
closeModalBtn.onclick = () => {
  modal.style.display = 'none';
};

async function getAccessToken() {
  try {
    const auth = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: 54292239, // замените на ваш ID приложения
      scope: 'audio'
    });
    return auth.access_token;
  } catch (e) {
    alert('Не удалось получить доступ к аудио: ' + (e.message || JSON.stringify(e)));
    return null;
  }
}

async function searchAudioVK(query, token) {
  if (!query || !token) return [];
  try {
    const response = await vkBridge.send('VKWebAppCallAPIMethod', {
      method: 'audio.search',
      params: {
        q: query,
        count: 20,
        sort: 2, // для более релевантных результатов
        access_token: token,
        v: '5.131'
      }
    });
    return response.response.items;
  } catch (e) {
    alert('Ошибка поиска аудио: ' + (e.message || JSON.stringify(e)));
    return [];
  }
}

searchBtn.onclick = async () => {
  const query = searchInput.value.trim();
  if (!query) return;
  searchResultsDiv.innerHTML = 'Поиск...';

  const token = await getAccessToken();
  if (!token) {
    searchResultsDiv.innerHTML = 'Нет доступа к аудио';
    return;
  }

  const results = await searchAudioVK(query, token);

  if (!results.length) {
    searchResultsDiv.innerHTML = 'Ничего не найдено';
    return;
  }

  searchResultsDiv.innerHTML = '';
  results.forEach(track => {
    const div = document.createElement('div');
    div.textContent = `${track.artist} — ${track.title}`;
    div.onclick = () => {
      playlist.push({title: track.title, artist: track.artist, url: track.url});
      renderPlaylist();
      if (currentTrackIndex === -1) playTrack(0);
      modal.style.display = 'none'; // Закрыть окно после выбора
    };
    searchResultsDiv.appendChild(div);
  });
};

// Инициализация VK Mini App
vkBridge.send('VKWebAppInit').then(() => {
  console.log('VK Mini App Initialized');
});
</script>

</body>
</html>
