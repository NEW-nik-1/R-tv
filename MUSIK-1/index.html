<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>VK Mini App Авторизация и API</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
</head>
<body>

<h2>VK Mini App: Авторизация и вызов API</h2>
<button id="authBtn">Авторизоваться и получить данные пользователя</button>
<button id="audioBtn">Попробовать получить аудио (если доступно)</button>

<pre id="output"></pre>

<script>
const VK_APP_ID = 54306429; // Ваш ID приложения
const output = document.getElementById('output');

async function vkAuth() {
  try {
    await vkBridge.send('VKWebAppInit');
    output.textContent = 'VK Bridge инициализирован.\n';

    // Получаем токен с правами на аудио
    const auth = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: VK_APP_ID,
      scope: 'audio'
    });
    output.textContent += 'Токен получен: ' + auth.access_token + '\n';

    // Получаем информацию о пользователе  
    const user = await vkBridge.send('VKWebAppGetUserInfo');
    output.textContent += 'Пользователь: ' + user.first_name + ' ' + user.last_name + '\n';

    return auth.access_token;
  } catch (error) {
    output.textContent += 'Ошибка авторизации или доступа: ' + (error.message || JSON.stringify(error)) + '\n';
    return null;
  }
}

async function getAudio(accessToken) {
  if (!accessToken) {
    output.textContent += 'Нет токена доступа. Сначала авторизуйтесь.\n';
    return;
  }
  try {
    const response = await vkBridge.send('VKWebAppCallAPIMethod', {
      method: 'audio.search',
      params: {
        q: 'test',
        count: 5,
        access_token: accessToken,
        v: '5.131'
      }
    });
    if (response.response && response.response.items) {
      output.textContent += 'Аудиозаписи:\n';
      response.response.items.forEach(track => {
        output.textContent += `${track.artist} — ${track.title}\n`;
      });
    } else {
      output.textContent += 'Аудио не найдено или доступ ограничен.\n';
    }
  } catch (error) {
    output.textContent += 'Ошибка при получении аудио: ' + (error.message || JSON.stringify(error)) + '\n';
  }
}

let currentToken = null;

document.getElementById('authBtn').onclick = async () => {
  currentToken = await vkAuth();
};

document.getElementById('audioBtn').onclick = async () => {
  await getAudio(currentToken);
};
</script>

</body>
</html>
