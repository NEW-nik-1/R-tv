<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VK Mini App с VK Bridge</title>
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button { font-size: 16px; margin: 5px; padding: 10px 15px; cursor: pointer;}
  pre { white-space: pre-wrap; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
</style>
</head>
<body>

<h2>Мини-приложение VK с VK Bridge</h2>
<button id="btnAuth">Авторизация с доступом к аудио</button>
<button id="btnSearchAudio">Поиск аудиозаписей</button>

<pre id="output"></pre>

<script>
const VK_APP_ID = 54306429;
const vkBridge = window.vkBridge;

const output = document.getElementById('output');
const btnAuth = document.getElementById('btnAuth');
const btnSearchAudio = document.getElementById('btnSearchAudio');

let accessToken = null;

function log(msg) {
  output.textContent += msg + "\\n";
  output.scrollTop = output.scrollHeight;
}

// Инициализация VK Bridge с обработкой ошибок
async function initializeVKBridge() {
  try {
    await vkBridge.send('VKWebAppInit');
    log('VK Bridge инициализирован');
  } catch (e) {
    log('Ошибка инициализации VK Bridge: ' + (e.message || e));
  }
}

// Авторизация с запросом доступа к аудио
async function authorize() {
  try {
    const auth = await vkBridge.send('VKWebAppGetAuthToken', {
      app_id: VK_APP_ID,
      scope: 'audio'
    });
    accessToken = auth.access_token;
    log('Авторизация успешна, токен получен.');

    const user = await vkBridge.send('VKWebAppGetUserInfo');
    log(`Пользователь: ${user.first_name} ${user.last_name} (ID: ${user.id})`);
  } catch (e) {
    log('Ошибка авторизации: ' + (e.message || JSON.stringify(e)));
  }
}

// Поиск аудиозаписей с обработкой возможных ограничений
async function searchAudio() {
  if (!accessToken) {
    log('Сначала выполните авторизацию.');
    return;
  }
  try {
    const response = await vkBridge.send('VKWebAppCallAPIMethod', {
      method: 'audio.search',
      params: {
        q: 'test',
        count: 5,
        access_token: accessToken,
        v: '5.131'
      }
    });

    if (response.response && response.response.items.length > 0) {
      log('Найденные аудиозаписи:');
      response.response.items.forEach((track, i) => {
        log(`${i+1}. ${track.artist} — ${track.title}`);
      });
    } else {
      log('Аудио не найдено или доступ ограничен.');
    }
  } catch (e) {
    log('Ошибка при получении аудио: ' + (e.message || JSON.stringify(e)));
  }
}

// Обработчики кнопок
btnAuth.onclick = async () => {
  await initializeVKBridge();
  await authorize();
};

btnSearchAudio.onclick = searchAudio;

// Автоматическая инициализация VK Bridge при загрузке страницы
initializeVKBridge();
</script>

</body>
</html>
