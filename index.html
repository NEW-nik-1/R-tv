<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Мультимедиа Центр IPTV/Радио/Игры — HTML5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- HLS.js для HLS-видео -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{
      --header-bg: #23244a;
      --main-bg:  #1e1c29;
      --card-bg:   #fff;
      --font-main: #23243a;
      --btn-bg:    #374285;
      --btn-hover: #496bd3;
      --btn-act:   #2187ff;
      --btn-radius: 45px;
      --btn-text:  #fff;
      --btn-height: 56px;
      --btn-width: 140px;
      --btn-fontsize: 1.14em;
      --conv-btn:  #42b687;
      --record-on: #DF1E29;
      --record-off: #44A147;
      --menu-bg:   #805cf6;
      --shadow: 0 3px 19px #0004;
      --game-bg: #23244a;
      --modal-bg: #fffefb;
      --admin-mask: rgba(24,24,44,.89);
      --scroll-col: #3c4689;
      --header-height:74px;
      --main-width:1100px;
      --player-width:100%;
      --player-height:380px;
      --game-win-w:820px;
      --game-win-h:530px;
      --btn-textsize:20px;
    }
    body {font-family:system-ui,sans-serif;margin:0;color:var(--font-main);background: var(--main-bg);}
    header {
      background: var(--header-bg);height:var(--header-height);
      display:flex;justify-content:center;align-items:center;min-height:var(--header-height);
      box-shadow:0 3px 15px #0002;position:sticky;top:0;z-index:23;
    }
    .header-bar{
      display:flex;align-items:center;justify-content:center;gap:22px;width:100%;height:100%;
    }
    .header-bar .btn {
      border:none;background:var(--btn-bg);color:var(--btn-text);
      border-radius:var(--btn-radius);font-size:var(--btn-fontsize);cursor:pointer;transition:0.18s;
      outline:none;min-width:var(--btn-width);height:var(--btn-height);box-shadow:0 1px 7px #0002;
      padding:0 22px;display:flex;align-items:center;justify-content:center;
      font-size:var(--btn-textsize);
    }
    .header-bar .btn:hover:not(.active):not(.conv):not(.games) {background:var(--btn-hover);}
    .header-bar .btn.active {background:var(--btn-act);}
    .header-bar .btn.conv    {background:var(--conv-btn);}
    .header-bar .btn.conv:hover{background:#3cc494;}
    .header-bar .btn.games   {background:var(--menu-bg);}
    .header-bar .btn.games:hover{background:#6f3ef7;}
    .btn-settings {
      background:#24243d;color:#fff;padding:.63em 1em;border:none;border-radius:999px;cursor:pointer;
      font-size:1.6em;margin-left:22px;outline:none;transition:.19s;
      display:flex;align-items:center;justify-content:center;height:var(--btn-height);width:var(--btn-height);
    }
    .btn-settings:hover {background:#265b6b;}
    .settings-ico::before {
      content: url('data:image/svg+xml;utf8,<svg width="26" height="26" stroke="white" fill="none" stroke-linecap="round" stroke-width="2" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><circle cx="13" cy="13" r="6"/><path d="M13 2V6"/><path d="M13 20v4"/><path d="M4 13H0"/><path d="M26 13h-4"/><path d="M4.6 4.6l2.8 2.8"/><path d="M21.4 4.6l-2.8 2.8"/><path d="M21.4 21.4l-2.8-2.8"/><path d="M4.6 21.4l2.8-2.8"/></svg>');
      display:inline-block;vertical-align:middle;}
    .container {max-width:var(--main-width);margin:45px auto 0;background:var(--card-bg);
      border-radius:26px;box-shadow:var(--shadow);padding:2.6em 5vw 2.7em 5vw;width:100%;min-width:320px;}
    main {margin-top:1.7em;}
    #tvSection,#radioSection{margin-bottom:2.1em;}
    .player-wrap{background:#202142;border-radius:15px;padding:18px 13px 23px 13px;box-shadow:0 5px 22px #0001;}
    video {display:block;width:var(--player-width);background:#000;border-radius:11px;height:var(--player-height);}
    .notify{
      padding:9px 17px 11px 45px;background:#fff8dc url('data:image/svg+xml;utf8,<svg width="22" height="22" fill="orange" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.9 4.21c-.79-2.11-3.89-2.11-4.68 0L2.997 15.03c-.692 1.846.755 3.825 2.625 3.825h8.755c1.87 0 3.317-1.979 2.625-3.825L12.9 4.21zM10 17a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm0-4.25a1 1 0 01-1-1V9a1 1 0 112 0v2.75a1 1 0 01-1 1z"/></svg>') no-repeat 17px center;
      border-radius:11px; color:#785700; font-size:1.13em; margin:1em 0 1.1em 0;box-shadow:0 2px 13px #ddd3;
    }
    .scroller {
      max-height:140px;overflow:auto; margin:23px 0;border-radius:13px;
      background:#f7f8fc;box-shadow:var(--shadow); border:1px solid #f1f1fa;
      padding:11px 7px 15px 7px;
    }
    .stream-list button {
      width:100%;display:block;border:none;padding:13px 0;font-size:1.13em;
      background:transparent;border-bottom:1px solid #e0e1f7;
      cursor:pointer;transition:background .18s;
    }
    .stream-list button:last-child{border-bottom:none;}
    .stream-list button.active {background:var(--btn-act);color:#fff;font-weight:700;}
    .stream-list button:focus {outline:2px solid var(--btn-act);}
    #recordSection,#recordSectionAudio{margin-top:15px;}
    .download-link {display:block; margin-top:8px;font-size:1.01em;color:var(--btn-act);text-decoration:underline;cursor:pointer;}
    /* --- Кастомный аудио плеер --- */
    .custom-audio-wrap{background:#212445;border-radius:14px;padding:26px 19px 22px 19px;box-shadow:0 2px 18px #5553;margin-bottom:16px;}
    .audio-controls{display:flex;align-items:center;gap:1.25em;}
    .audio-btn{
      width:42px;height:42px;border-radius:50%;border:none;background:#fff;box-shadow:0 1px 5px #0001;
      font-size:1.32em;cursor:pointer;display:flex;align-items:center;justify-content:center;
      margin-right:14px;transition:.13s;
    }
    .audio-btn:active{background:#ececec;}
    .audio-btn .icon{pointer-events:none;}
    .volume-bar-wrap {display:flex;align-items:center;}
    .volume-bar{
      width:96px;height:8px;background:#ececec;border-radius:6px;position:relative;overflow:hidden;cursor:pointer;
      margin:0 9px;
    }
    .volume-fill{height:100%;background:var(--btn-act);border-radius:6px;position:absolute;top:0;left:0;}
    .audio-time{font-size:.98em;color:#fff;min-width:49px;}
    .audio-title{font-size:1.18em;color:#fff;font-weight:580;margin-bottom:8px;letter-spacing:.7px;}
    /* --- ИГРЫ --- */
    .overlay-full{position:fixed;left:0;top:0;right:0;bottom:0;z-index:900;background:none;pointer-events:none;}
    .games-menu {
      position:fixed;top:calc(var(--header-height) + 7px);right:23px;z-index:999;
      width:330px;max-height:70vh;min-height:120px;padding:1.10em 1.1em 1.13em 1.4em;
      background:var(--menu-bg); box-shadow:0 10px 33px #0006;border-radius:13px;overflow:auto;display:none;pointer-events:auto;
    }
    .games-menu h4{margin:0 0 18px 0;color:#fff;}
    .gm-item{display:flex;align-items:center;margin-bottom:14px;}
    .gm-thumb{width:28px;height:28px;background:#b9d2ed;border-radius:7px;
      display:flex;align-items:center;justify-content:center;font-size:16px;
      margin-right:15px;}
    .gm-title{color:#fff;font-size:1.09em;}
    .gm-playbtn{margin-left:auto; background: var(--btn-act); color:#fff;
      border:none;border-radius:999px; font-size:.99em;padding:7px 15px;cursor:pointer;}
    .game-frame-box{
      position:fixed;bottom:27px;right:19px;z-index:1100;
      width:var(--game-win-w); height:var(--game-win-h); background:var(--main-bg);
      border-radius:18px;box-shadow:0 13px 38px 13px #0007;overflow:hidden;display:none;flex-direction:column;
      min-width:220px;max-width:calc(100vw - 48px);max-height:99vh;transition:.18s cubic-bezier(.5,0,.5,1);}
    .game-frame-box.maximized{width:100vw;height:100vh;top:0;left:0;right:0;bottom:0;margin:0;z-index:1200;}
    .gameframe-header {height:49px;background:#334588;display:flex;align-items:center;
      justify-content:space-between;padding:0 17px;font-size:1.09em;}
    .g-title{color:#fff;font-size:1.18em;}
    .g-controls{display:flex;align-items:center;gap:13px;}
    .g-ico{display:inline-block;width:25px;height:25px;background:transparent;cursor:pointer; border:none;
      padding:0;outline:none;font-size:1.18em;border-radius:2px;transition:.1s;}
    .g-ico.square::before{content:'\25A1';color:#38e;}
    .g-ico.minus::before{content:'\2013';color:#ffe18f;}
    .g-ico.tip::before{content:'\2754';color:#fae737;}
    .g-ico.close::before{content:'\2716';color:#e83849;}
    .game-frame-box.minimized {bottom:7px;right:9px;width:250px;min-width:80px;max-width:98vw;height:52px;overflow:hidden;transition:.13s;}
    .game-frame-iframe{width:100%;height:100%;border:none;background:white;flex:1;}
    .gm-tip-balloon {background:#fefae2;color:#7c600a;font-size:1.02em;border-radius:9px;
      border:1px solid #ffe497;min-width:170px;max-width:340px;padding:13px 17px 12px 15px;
      box-shadow:0 3px 13px #0003;position:absolute;top:63px;right:19px;z-index:20000;display:none;}
    .games-menu::-webkit-scrollbar,
    .scroller::-webkit-scrollbar{width:8px;background:#0000;}
    .games-menu::-webkit-scrollbar-thumb,
    .scroller::-webkit-scrollbar-thumb{background:var(--scroll-col);border-radius:10px;}
    #settingsPanelBg{position:fixed;z-index:2000;left:0;top:0;right:0;bottom:0;background:rgba(16,19,38,.82);display:none;}
    #settingsPanel{
      position:fixed;z-index:2100;top:29px;left:0;right:0;max-width:1460px;margin:0 auto;
      background:var(--modal-bg);border-radius:26px;box-shadow:0 13px 50px #0009;
      padding:2.8em 3.3em 2.8em 3.3em;display:none;overflow:auto;max-height:97vh;
    }
    #settingsPanel h2 {margin-top:0;}
    .form-row{display:flex;align-items:center;margin-bottom:1.45em;}
    .form-row label{min-width:214px;font-size:1.06em;}
    .form-row input:not([type="color"]),.form-row select {
      flex:1;margin-left:14px;font-size:1.07em;padding:8px 13px;border-radius:7px;border:1px solid #bbb;}
    .setList{margin-bottom:18px;}
    .setList .item-row{display:flex;align-items:center;gap:8px;margin-bottom:13px;}
    .setList .item-row input[type="text"]{flex:2;}
    .setList .item-row button {font-size:.98em;padding:5px 13px;}
    .add-btn{margin-top:2px;background: var(--btn-act);color:#fff;}
    .settings-actions{display:flex;justify-content:flex-end;gap:17px;}
    #adminAuthBg{position:fixed;z-index:4000;left:0;top:0;right:0;bottom:0;background:var(--admin-mask);display:none;}
    #adminAuthForm{position:fixed;z-index:4100;top:63px;left:0;right:0;max-width:490px;margin:0 auto;
      background:var(--modal-bg);border-radius:23px;box-shadow:0 13px 40px #0008;padding:2.15em 2.7em 2.4em 2.6em;display:none;overflow:auto;max-height:72vh;}
    #adminAuthForm h3 {margin-top:0;}
    #miniHlsTest input{width:67%;margin-right:10px;}
    #miniHlsVideo{margin-top:7px;max-width:420px;}
    @media (max-width:1350px){ .container{max-width:99vw} .game-frame-box{width:99vw !important;}#settingsPanel{max-width:99vw;}}
    @media (max-width:900px){
      header{flex-wrap:wrap;gap:9px;}
      .container{padding:1.02em;}
      .games-menu{right:2vw;width:98vw;}
      .game-frame-box{left:2vw;min-width:60px;}
      #settingsPanel{max-width:99vw;padding:1.1em .9em;}
      #adminAuthForm{max-width:99vw;padding:1.3em 1em;}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-bar">
      <button class="btn" id="btnTV">ТВ</button>
      <button class="btn" id="btnRadio">РАДИО</button>
      <button class="btn conv" id="btnConv">Аудио/Видео конвертер</button>
      <button class="btn games" id="btnGames">ИГРЫ</button>
      <button class="btn-settings settings-ico" id="btnSettings" title="Настройки"></button>
    </div>
  </header>
  <div class="container">
    <main>
      <section id="tvSection" style="display:none">
        <div class="player-wrap">
          <video id="videoPlayer" controls playsinline></video>
        </div>
        <div id="tvNotify" class="notify" style="display:none"></div>
        <div class="scroller">
          <div class="stream-list" id="videoStreamList"></div>
        </div>
        <div id="recordSection">
          <button class="btn" id="btnRecordVideo">Запись видео</button>
          <a class="download-link" id="downloadVideoLink" style="display:none" download="recorded_video.webm">Скачать видео</a>
        </div>
      </section>
      <section id="radioSection" style="display:none">
        <div class="custom-audio-wrap">
          <div class="audio-title" id="audioTitle"></div>
          <div class="audio-controls">
            <button class="audio-btn" id="audioPlayBtn" title="Пуск/Пауза"><span class="icon" id="playIcon">&#9654;</span><span class="icon" id="pauseIcon" style="display:none">&#10073;&#10073;</span></button>
            <div class="audio-time" id="audioCurTime">00:00</div>
            <div class="volume-bar-wrap">
              <span style="color:#fff;font-size:1.2em">&#128266;</span>
              <div class="volume-bar" id="volumeBar">
                <div class="volume-fill" id="volumeFill"></div>
              </div>
            </div>
          </div>
          <audio id="audioPlayer" preload="none"></audio>
        </div>
        <div id="radioNotify" class="notify" style="display:none"></div>
        <div class="scroller">
          <div class="stream-list" id="audioStreamList"></div>
        </div>
        <div id="recordSectionAudio">
          <button class="btn" id="btnRecordAudio">Запись аудио</button>
          <a class="download-link" id="downloadAudioLink" style="display:none" download="recorded_audio.webm">Скачать аудио</a>
        </div>
      </section>
    </main>
  </div>
  <div class="overlay-full"></div>
  <div class="games-menu" id="gamesMenu">
    <h4>Игры</h4>
    <div id="gamesList"></div>
  </div>
  <div class="game-frame-box" id="gameFrameBox">
    <div class="gameframe-header">
      <span class="g-title" id="gameTitle"></span>
      <div class="g-controls">
        <button class="g-ico tip" id="gTipBtn" title="Подсказка"></button>
        <button class="g-ico minus" id="gMinBtn" title="Свернуть"></button>
        <button class="g-ico square" id="gMaxBtn" title="Развернуть / вернуть"></button>
        <button class="g-ico close" id="gCloseBtn" title="Закрыть"></button>
      </div>
    </div>
    <iframe class="game-frame-iframe" id="gameIframe" frameborder="0" allowfullscreen></iframe>
  </div>
  <div class="gm-tip-balloon" id="gmTipBalloon">
    Отключить звук можно в настройках/панели самой игры (значок <b>громкости</b> внутри окна игры).
  </div>
  <div id="settingsPanelBg"></div>
  <div id="settingsPanel"></div>
  <div id="adminAuthBg"></div>
  <div id="adminAuthForm">
    <form id="authForm">
      <h3>Вход в панель настроек</h3>
      <div class="form-row">
        <label>Логин</label>
        <input type="text" name="login" autocomplete="username" required>
      </div>
      <div class="form-row">
        <label>Пароль</label>
        <input type="password" name="password" autocomplete="current-password" required>
      </div>
      <div class="settings-actions">
        <button class="btn" id="authBtn" style="margin-top:9px;">Войти</button>
      </div>
    </form>
  </div>
  <script>
    // -------- ДАННЫЕ -----------
    let tvStreams = [
      {name:"RU-TV",url:"https://hls-03-video.webcaramba.com/rutv/live_720/index.m3u8"},
      {name:"Шансон-TV",url:"http://chanson-video.hostingradio.ru:8080/hls/chansonabr/live.m3u8"},
    ];
    let radioStreams = [
      {name:"Радио СИТИ",url:"https://online2.100i6fm.ru/city"},
      {name:"Авторадио",url:"https://pub0101.101.ru/stream/air/aac/64/100"},
    ];
    let games = [
      {name:"2D Drift Hunters",url:"https://html5.gamemonetize.co/dd5rs8etri5hw51g32sk69qfdoov5tq2/",w:"100%",h:"570"},
      {name:"Tomb Runner",url:"https://games.engineering.com/tomb-runner-1/index.html",w:"100%",h:"570"},
      {name:"Highway Traffic",url:"https://www.onlinegames.io/games/2022/unity/highway-traffic/index.html",w:"865",h:"560"},
    ];
    let uiColors = {record_on:"#DF1E29",record_off:"#44A147",btn_header_bg:"#374285",btn_header_text:"#fff",
      header_bg:"#23244a",main_bg:"#1e1c29",card_bg:"#fff",btn_radius:"45px",btn_width:"140px",btn_height:"56px",
      btn_textsize:"20px",
      header_height:"74px",main_width:"1100px",player_width:"100%",player_height:"380px",game_win_w:"820px",game_win_h:"530px"
    };
    let adminLogin = "admin", adminPass = "1234";
    const btnTV=document.getElementById('btnTV'), btnRadio=document.getElementById('btnRadio'),
      btnConv=document.getElementById('btnConv'), btnGames=document.getElementById('btnGames'), btnSettings=document.getElementById('btnSettings'),
      tvSection=document.getElementById('tvSection'), radioSection=document.getElementById('radioSection'),
      videoPlayer=document.getElementById('videoPlayer'), audioPlayer=document.getElementById('audioPlayer'),
      audioTitle=document.getElementById('audioTitle'), audioPlayBtn=document.getElementById('audioPlayBtn'),
      playIcon=document.getElementById('playIcon'), pauseIcon=document.getElementById('pauseIcon'), audioCurTime=document.getElementById('audioCurTime'),
      volumeBar=document.getElementById('volumeBar'), volumeFill=document.getElementById('volumeFill'),
      videoStreamList=document.getElementById('videoStreamList'), audioStreamList=document.getElementById('audioStreamList'),
      btnRecordVideo=document.getElementById('btnRecordVideo'), btnRecordAudio=document.getElementById('btnRecordAudio'),
      downloadVideoLink=document.getElementById('downloadVideoLink'), downloadAudioLink=document.getElementById('downloadAudioLink'),
      tvNotify=document.getElementById('tvNotify'), radioNotify=document.getElementById('radioNotify'),
      gamesMenu=document.getElementById('gamesMenu'), gamesListDiv=document.getElementById('gamesList'),
      overlayFull=document.querySelector('.overlay-full'), gameFrameBox=document.getElementById('gameFrameBox'),
      gameTitle=document.getElementById('gameTitle'), gameIframe=document.getElementById('gameIframe'),
      gTipBtn=document.getElementById('gTipBtn'), gMinBtn=document.getElementById('gMinBtn'),gMaxBtn=document.getElementById('gMaxBtn'),gCloseBtn=document.getElementById('gCloseBtn'), gmTipBalloon=document.getElementById('gmTipBalloon'),
      settingsPanelBg=document.getElementById('settingsPanelBg'), settingsPanel=document.getElementById('settingsPanel'),
      adminAuthBg=document.getElementById('adminAuthBg'), adminAuthForm=document.getElementById('adminAuthForm'),
      authForm=document.getElementById('authForm');
    let hls=null, activeVideoStream=null, activeAudioStream=null;
    let mediaRecorderVideo=null, recordedChunksVideo=[];
    let mediaRecorderAudio=null, recordedChunksAudio=[];
    let currentMode='radio', settingsOpen=false, isAdminLogged=false, miniHls = null;
    // --- CSS Vars Live ---
    function applyVars(){
      let r = document.documentElement;
      for(let k in uiColors) if(k in r.style) r.style.setProperty('--'+k.replace(/_/g,"-"),uiColors[k]);
      document.querySelectorAll('.header-bar .btn').forEach(b=>{
        b.style.background=uiColors.btn_header_bg; b.style.color=uiColors.btn_header_text;
        b.style.borderRadius = uiColors.btn_radius; b.style.width = uiColors.btn_width; b.style.height = uiColors.btn_height;
        b.style.fontSize = uiColors.btn_textsize;
      });
      btnRecordAudio.style.background=uiColors.record_off; btnRecordVideo.style.background=uiColors.record_off;
      document.querySelectorAll('.container').forEach(wp=>{
        wp.style.background=uiColors.card_bg; wp.style.maxWidth = uiColors.main_width;
      });
      videoPlayer.style.height=uiColors.player_height; gameFrameBox.style.width=uiColors.game_win_w; gameFrameBox.style.height=uiColors.game_win_h;
      document.querySelector('header').style.height=uiColors.header_height;
    }
    function updateBtnUI(){
      btnTV.classList.toggle('active',currentMode==='tv');
      btnRadio.classList.toggle('active',currentMode==='radio');
      btnGames.classList.remove('active');
    }
    function showSection(section){
      tvSection.style.display = (section==='tv')?'block':'none';
      radioSection.style.display = (section==='radio')?'block':'none';
    }
    function renderVideoStreams(){
      videoStreamList.innerHTML = '';
      tvStreams.forEach((s,i)=>{
        let btn = document.createElement('button');
        btn.textContent = s.name;
        btn.onclick = ()=>{ playVideoStream(s.url); setActiveBtn(videoStreamList,btn);}
        btn.setAttribute('data-index',i);
        videoStreamList.appendChild(btn);
      });
    }
    function playVideoStream(url){
      if(mediaRecorderVideo && mediaRecorderVideo.state==="recording"){
        notify(tvNotify,"Остановите запись перед сменой потока!",2600);return;
      }
      activeVideoStream=url;
      if(hls){hls.destroy();hls=null;}
      if(videoPlayer.canPlayType('application/vnd.apple.mpegurl')){
        videoPlayer.src=url; videoPlayer.play().catch(()=>{});
      } else if(Hls.isSupported()){
        hls=new Hls(); hls.loadSource(url); hls.attachMedia(videoPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{videoPlayer.play().catch(()=>{});})
      } else{
        alert('Ваш браузер не поддерживает HLS поток');
      }
    }
    function stopVideo(){if(hls){hls.destroy();hls=null;}videoPlayer.pause();videoPlayer.removeAttribute('src');videoPlayer.load();activeVideoStream=null;}
    function renderAudioStreams(){
      audioStreamList.innerHTML = '';
      radioStreams.forEach((s,i)=>{
        let btn = document.createElement('button');
        btn.textContent = s.name;
        btn.onclick = ()=>{ playAudioStream(s.url,i); setActiveBtn(audioStreamList,btn);}
        btn.setAttribute('data-index',i);
        audioStreamList.appendChild(btn);
      });
    }
    // Кастомный радио плеер:
    let audioPaused = true, audioIndex = 0;
    function playAudioStream(url, idx){
      if(mediaRecorderAudio && mediaRecorderAudio.state==="recording"){
        notify(radioNotify,"Остановите запись перед сменой потока!",2300);return;
      }
      activeAudioStream=url; audioIndex=idx||0;
      audioPlayer.src=url;
      audioTitle.textContent = radioStreams[audioIndex]?.name||"";
      playCustomAudio();
      updateAudioBtn();
    }
    function setActiveBtn(list,btn){
      Array.from(list.children).forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }
    function playCustomAudio(){audioPlayer.play().catch(()=>{}); audioPaused=false; updateAudioBtn();}
    function pauseCustomAudio(){audioPlayer.pause(); audioPaused=true; updateAudioBtn();}
    function updateAudioBtn(){
      if(audioPlayer.paused){ playIcon.style.display=""; pauseIcon.style.display="none"; }
      else { playIcon.style.display="none"; pauseIcon.style.display=""; }
    }
    audioPlayBtn.onclick = ()=>{if(audioPlayer.paused){ playCustomAudio(); } else { pauseCustomAudio(); }};
    audioPlayer.onplay = updateAudioBtn; audioPlayer.onpause = updateAudioBtn;
    function formatT(sec){let m=Math.floor(sec/60),s=Math.floor(sec%60);if(isNaN(m)||isNaN(s))return "00:00";return (m<10?"0":"")+m+":"+(s<10?"0":"")+s;}
    audioPlayer.ontimeupdate = ()=>{audioCurTime.textContent=formatT(audioPlayer.currentTime);}
    let curVol=0.7;
    function setAudioVol(x){
      curVol=x;audioPlayer.volume=curVol; volumeFill.style.width=(curVol*100)+"%";
    }
    setAudioVol(curVol);
    volumeBar.onclick = function(e){
      let w=this.offsetWidth,offs=this.getBoundingClientRect();
      let x = (e.clientX-offs.left)/w; x = Math.max(0,Math.min(1,x));
      setAudioVol(x);
    }
    // == Игры ==
    function renderGamesMenu(){
      gamesListDiv.innerHTML = '';
      games.forEach((g,i)=>{
        let row=document.createElement('div');row.className='gm-item';
        let thumb=document.createElement('div');thumb.className='gm-thumb';thumb.textContent=(i+1);
        let title=document.createElement('div');title.className='gm-title';title.textContent=g.name;
        let btn=document.createElement('button');btn.className='gm-playbtn';btn.textContent='Запуск';
        btn.onclick=()=>{showGameFrame(g);gamesMenu.style.display='none';}
        row.append(thumb,title,btn);gamesListDiv.appendChild(row);
      });
    }
    function showGamesMenu(){gamesMenu.style.display = (gamesMenu.style.display==='block')?'none':'block';}
    function showGameFrame(g){
      gameTitle.textContent = g.name;
      gameFrameBox.style.display = 'flex';
      gameFrameBox.classList.remove('maximized','minimized');
      gameFrameBox.style.width=g.w||uiColors.game_win_w;
      gameFrameBox.style.height=g.h||uiColors.game_win_h;
      gameIframe.src = g.url;
    }
    gCloseBtn.onclick = hideGameFrame;
    function hideGameFrame(){gameFrameBox.style.display='none';gameIframe.src='';gmTipBalloon.style.display='none';}
    gMaxBtn.onclick = ()=>{
      gameFrameBox.classList.toggle('maximized');
      if(gameFrameBox.classList.contains('maximized')){
        gameFrameBox.style.width="100vw";gameFrameBox.style.height="100vh";
      }else{
        gameFrameBox.style.width=uiColors.game_win_w;gameFrameBox.style.height=uiColors.game_win_h;
      }
    }
    gMinBtn.onclick = ()=>{gameFrameBox.classList.toggle('minimized');}
    gTipBtn.onclick = ()=>{gmTipBalloon.style.display = gmTipBalloon.style.display==='block'?'none':'block';}
    document.addEventListener('click',e=>{
      if(e.target===btnGames) return;
      if(!gamesMenu.contains(e.target) && gamesMenu.style.display==='block')
        gamesMenu.style.display = 'none';
      if(!gameFrameBox.contains(e.target))
        gmTipBalloon.style.display='none';
    });
    btnConv.onclick = ()=>{window.open('https://www.freeconvert.com/webm-to-mp3','_blank')};
    btnTV.onclick = activateTV; btnRadio.onclick = activateRadio; btnGames.onclick=showGamesMenu;
    function activateTV(){
      if(currentMode==='tv')return;currentMode='tv';updateBtnUI();showSection('tv');
      gamesMenu.style.display='none';stopAudio();downloadAudioLink.style.display='none';
      if(!activeVideoStream){(videoStreamList.querySelector('button')||{}).click?.();}
      else{playVideoStream(activeVideoStream);
        [...videoStreamList.children].forEach(btn=>{
          let idx=btn.getAttribute('data-index')|0;
          if(tvStreams[idx]?.url===activeVideoStream) setActiveBtn(videoStreamList,btn);
        });
      }
      hideGameFrame();
    }
    function activateRadio(){
      if(currentMode==='radio')return;currentMode='radio';updateBtnUI();showSection('radio');
      gamesMenu.style.display='none';stopVideo();downloadVideoLink.style.display='none';
      if(!activeAudioStream){(audioStreamList.querySelector('button')||{}).click?.();}
      else{playAudioStream(activeAudioStream,audioIndex);
        [...audioStreamList.children].forEach(btn=>{
          let idx=btn.getAttribute('data-index')|0;
          if(radioStreams[idx]?.url===activeAudioStream) setActiveBtn(audioStreamList,btn);
        });
      }
      hideGameFrame();
    }
    btnRecordVideo.onclick = ()=>{
      if(mediaRecorderVideo && mediaRecorderVideo.state==="recording"){
        mediaRecorderVideo.stop();
        btnRecordVideo.classList.remove('recording');
        btnRecordVideo.style.background=uiColors.record_off;
        btnRecordVideo.textContent = "Запись видео";
      } else {
        if(!activeVideoStream){notify(tvNotify,"Сначала выберите ТВ‑канал из списка",2200);return;}
        startVideoRecording();
      }
    }
    function notify(el,msg,time=2700){el.innerHTML=msg; el.style.display='block'; setTimeout(()=>{el.style.display='none';},time);}
    function startVideoRecording(){
      if(!videoPlayer.captureStream){
        notify(tvNotify,"Ваш браузер не поддерживает запись видео.",2600);return;
      }
      notify(tvNotify,"<b>Отключите микрофон!</b> Запись — только звук с видео.");
      btnRecordVideo.classList.add('recording');
      btnRecordVideo.style.background = uiColors.record_on;
      btnRecordVideo.textContent="Остановить запись";
      downloadVideoLink.style.display='none';recordedChunksVideo=[];
      let stream = videoPlayer.captureStream();
      mediaRecorderVideo = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8,opus'});
      mediaRecorderVideo.ondataavailable = e=>{
        if(e.data.size>0) recordedChunksVideo.push(e.data);
      }
      mediaRecorderVideo.onstop = ()=>{
        btnRecordVideo.classList.remove('recording');
        btnRecordVideo.style.background=uiColors.record_off;
        btnRecordVideo.textContent="Запись видео";
        const blob = new Blob(recordedChunksVideo,{type:'video/webm'});
        downloadVideoLink.href = URL.createObjectURL(blob);
        downloadVideoLink.style.display='inline-block';
      }
      mediaRecorderVideo.start();
    }
    btnRecordAudio.onclick = ()=>{
      if(mediaRecorderAudio && mediaRecorderAudio.state==="recording"){
        mediaRecorderAudio.stop();
        btnRecordAudio.classList.remove('recording');
        btnRecordAudio.style.background=uiColors.record_off;
        btnRecordAudio.textContent = "Запись аудио";
      } else {
        if(!activeAudioStream){notify(radioNotify,"Сначала выберите радио из списка",2100);return;}
        startAudioRecording();
      }
    }
    async function startAudioRecording() {
      notify(radioNotify,"<b>Отключите микрофон!</b> Запись — только плеер.");
      btnRecordAudio.classList.add('recording');
      btnRecordAudio.style.background=uiColors.record_on;
      btnRecordAudio.textContent="Остановить запись";
      downloadAudioLink.style.display='none';recordedChunksAudio=[];
      const AudioContext = window.AudioContext||window.webkitAudioContext;
      const ctx = new AudioContext();
      let src;
      try {src = ctx.createMediaElementSource(audioPlayer);}
      catch (e) {notify(radioNotify,"Ошибка MediaElementSource",2100);return;}
      let dest = ctx.createMediaStreamDestination();
      src.connect(dest);src.connect(ctx.destination);
      mediaRecorderAudio = new MediaRecorder(dest.stream,{mimeType:'audio/webm'});
      mediaRecorderAudio.ondataavailable = e=>{
        if(e.data.size>0) recordedChunksAudio.push(e.data);
      }
      mediaRecorderAudio.onstop = ()=>{
        btnRecordAudio.classList.remove('recording');
        btnRecordAudio.style.background=uiColors.record_off;
        btnRecordAudio.textContent="Запись аудио";
        const blob = new Blob(recordedChunksAudio,{type:'audio/webm'});
        downloadAudioLink.href = URL.createObjectURL(blob);
        downloadAudioLink.style.display='inline-block';
      }
      mediaRecorderAudio.start();
    }
    // -- SETTINGS --
    btnSettings.onclick=()=>{if(!isAdminLogged) showAdminAuth(); else openSettingsPanel();};
    function showAdminAuth(){adminAuthBg.style.display = adminAuthForm.style.display = 'block';}
    adminAuthBg.onclick = ()=>{ adminAuthBg.style.display = adminAuthForm.style.display='none'; };
    authForm.onsubmit = function(e){
      e.preventDefault();
      let l = authForm.login.value, p = authForm.password.value;
      if(l===adminLogin&&p===adminPass){
        isAdminLogged = true;
        adminAuthBg.style.display = adminAuthForm.style.display = 'none';
        openSettingsPanel();
      }else{
        alert('Неверный логин или пароль');
      }
      return false;
    }
    function openSettingsPanel(){
      settingsPanelBg.style.display = settingsPanel.style.display = 'block';
      settingsOpen = true;
      renderSettingsPanel();
    }
    settingsPanelBg.onclick = ()=>{ settingsPanelBg.style.display = settingsPanel.style.display ='none';settingsOpen = false;};
    // --- ПАНЕЛЬ НАСТРОЕК ---
    function renderSettingsPanel(){
      settingsPanel.innerHTML = `
      <h2>Настройки интерфейса, цветов, размеров, потоков</h2>
      <div class="settings-actions" style="margin-bottom:1.7em;">
        <button class="btn games" id="saveBtn">Скачать index.html</button>
        <button class="btn" id="closeSetBtn">Закрыть</button>
      </div>
      <form id="interfaceColorForm">
        <div class="form-row"><label>Цвет записи "ВКЛ"</label><input type="color" name="colRecOn" value="${uiColors.record_on}"></div>
        <div class="form-row"><label>Цвет записи "ВЫКЛ"</label><input type="color" name="colRecOff" value="${uiColors.record_off}"></div>
        <div class="form-row"><label>Цвет кнопок меню</label><input type="color" name="colBtnBg" value="${uiColors.btn_header_bg||"#374285"}"></div>
        <div class="form-row"><label>Цвет текста кнопок</label><input type="color" name="colBtnText" value="${uiColors.btn_header_text||"#fff"}"></div>
        <div class="form-row"><label>Цвет фона шапки</label><input type="color" name="colHeaderBg" value="${uiColors.header_bg||"#23244a"}"></div>
        <div class="form-row"><label>Цвет фона страницы</label><input type="color" name="colMainBg" value="${uiColors.main_bg||"#1e1c29"}"></div>
        <div class="form-row"><label>Цвет окон/плеера</label><input type="color" name="colCardBg" value="${uiColors.card_bg||"#fff"}"></div>
        <div class="form-row"><label>Округлость кнопок (px)</label><input type="text" name="btnRadius" value="${uiColors.btn_radius}"></div>
        <div class="form-row"><label>Ширина кнопок (px/%)</label><input type="text" name="btnWidth" value="${uiColors.btn_width}"></div>
        <div class="form-row"><label>Высота кнопок (px)</label><input type="text" name="btnHeight" value="${uiColors.btn_height}"></div>
        <div class="form-row"><label>Размер текста кнопок (px|em)</label><input type="text" name="btnTextsize" value="${uiColors.btn_textsize}"></div>
        <div class="form-row"><label>Высота шапки (px)</label><input type="text" name="headerHeight" value="${uiColors.header_height}"></div>
        <div class="form-row"><label>Ширина основного окна (px/%/vw)</label><input type="text" name="mainWidth" value="${uiColors.main_width}"></div>
        <div class="form-row"><label>Ширина плеера (px/%/vw)</label><input type="text" name="playerWidth" value="${uiColors.player_width}"></div>
        <div class="form-row"><label>Высота плеера (px)</label><input type="text" name="playerHeight" value="${uiColors.player_height}"></div>
        <div class="form-row"><label>Ширина окна игры (px/%/vw)</label><input type="text" name="gameWinW" value="${uiColors.game_win_w}"></div>
        <div class="form-row"><label>Высота окна игры (px)</label><input type="text" name="gameWinH" value="${uiColors.game_win_h}"></div>
        <div class="form-row"><input type="submit" class="btn add-btn" value="Сохранить цвета/размеры"></div>
      </form>
      <hr>
      <h3>ТВ-каналы</h3>
      <div class="setList" id="tvSetList"></div>
      <button class="btn add-btn" id="addTVChan">+ Добавить канал</button>
      <hr>
      <h3>Радио</h3>
      <div class="setList" id="radioSetList"></div>
      <button class="btn add-btn" id="addRadioChan">+ Добавить радио</button>
      <hr>
      <h3>Игры</h3>
      <div class="setList" id="gamesSetList"></div>
      <button class="btn add-btn" id="addGame">+ Добавить игру</button>
      <hr>
      <h4>Маленький HLS-плеер для проверки ссылок</h4>
      <div id="miniHlsTest" style="margin:0 0 15px 0;">
        <input type="text" id="miniHlsUrl" placeholder="m3u8 ссылка..." spellcheck="false">
        <button class="btn" id="miniHlsBtn">Тест</button>
        <br><video id="miniHlsVideo" controls style="max-width:420px;"></video>
      </div>
      `;
      settingsPanel.querySelector('#interfaceColorForm').onsubmit=function(e){
        e.preventDefault();
        uiColors.record_on = this.colRecOn.value; uiColors.record_off = this.colRecOff.value;
        uiColors.btn_header_bg = this.colBtnBg.value; uiColors.btn_header_text = this.colBtnText.value;
        uiColors.header_bg = this.colHeaderBg.value; uiColors.main_bg = this.colMainBg.value;
        uiColors.card_bg = this.colCardBg.value; uiColors.btn_radius = this.btnRadius.value;
        uiColors.btn_width = this.btnWidth.value; uiColors.btn_height = this.btnHeight.value;
        uiColors.btn_textsize = this.btnTextsize.value;
        uiColors.header_height = this.headerHeight.value; uiColors.main_width = this.mainWidth.value;
        uiColors.player_width = this.playerWidth.value; uiColors.player_height = this.playerHeight.value;
        uiColors.game_win_w = this.gameWinW.value; uiColors.game_win_h = this.gameWinH.value;
        applyVars(); alert('Применено!'); return false;
      };
      // ТВ
      let tvSet = settingsPanel.querySelector('#tvSetList');
      tvSet.innerHTML = tvStreams.map((s,i)=>`<div class="item-row">
          <input type="text" value="${s.name}" data-tvid="${i}" style="max-width:39%">
          <input type="text" value="${s.url}" data-tvurl="${i}">
          <button onclick="this.parentElement.remove();">Удалить</button></div>`).join('');
      settingsPanel.querySelector('#addTVChan').onclick=()=>{
        let d=document.createElement('div');d.className='item-row';
        d.innerHTML = `<input type="text" placeholder="Название">
          <input type="text" placeholder="m3u8‑ссылка">
          <button onclick="this.parentElement.remove();">Удалить</button>`;
        tvSet.appendChild(d);
      }
      // Радио
      let radioSet=settingsPanel.querySelector('#radioSetList');
      radioSet.innerHTML = radioStreams.map((s,i)=>`<div class="item-row"><input type="text" value="${s.name}" data-rdid="${i}" style="max-width:41%">
          <input type="text" value="${s.url}" data-rdurl="${i}">
          <button onclick="this.parentElement.remove();">Удалить</button></div>`).join('');
      settingsPanel.querySelector('#addRadioChan').onclick=()=>{
        let d=document.createElement('div');d.className='item-row';
        d.innerHTML = `<input type="text" placeholder="Название">
          <input type="text" placeholder="stream‑ссылка">
          <button onclick="this.parentElement.remove();">Удалить</button>`;
        radioSet.appendChild(d);
      }
      // Игры
      let gamesSet = settingsPanel.querySelector('#gamesSetList');
      gamesSet.innerHTML = games.map((g,i)=>`<div class="item-row">
        <input type="text" value="${g.name}" data-gid="${i}">
        <input type="text" value="${g.url}" data-gurl="${i}" style="max-width:47%">
        <input type="text" value="${g.w}" style="width:62px;" title="ширина">
        <input type="text" value="${g.h}" style="width:62px;" title="высота">
        <button onclick="this.parentElement.remove();">Удалить</button></div>`).join('');
      settingsPanel.querySelector('#addGame').onclick=()=>{
        let d=document.createElement('div');d.className='item-row';
        d.innerHTML=`<input type="text" placeholder="Название">
          <input type="text" placeholder="game‑ссылка" style="max-width:47%">
          <input type="text" placeholder="ширина" style="width:62px;">
          <input type="text" placeholder="высота" style="width:62px;">
          <button onclick="this.parentElement.remove();">Удалить</button>`;
        gamesSet.appendChild(d);
      }
      let miniVid = settingsPanel.querySelector('#miniHlsVideo');
      settingsPanel.querySelector('#miniHlsBtn').onclick=()=>{
        let url = settingsPanel.querySelector('#miniHlsUrl').value.trim();if(!url) return;
        if(miniHls){miniHls.destroy();miniHls=null;}
        if(miniVid.canPlayType('application/vnd.apple.mpegurl')){
          miniVid.src = url; miniVid.play().catch(()=>{});
        } else if(Hls.isSupported()){
          miniHls = new Hls();
          miniHls.loadSource(url);
          miniHls.attachMedia(miniVid);
          miniHls.on(Hls.Events.MANIFEST_PARSED,()=>{miniVid.play().catch(()=>{});});
        }
      }
      settingsPanel.querySelector('#closeSetBtn').onclick=()=>{
        settingsPanelBg.style.display = settingsPanel.style.display ='none';settingsOpen=false;
      };
      settingsPanel.querySelector('#saveBtn').onclick=()=>{
        let newTV=[],tvrows=tvSet.querySelectorAll('.item-row');
        for(let row of tvrows){let vals=row.querySelectorAll('input');if(!vals[0].value.trim())continue;
          newTV.push({name:vals[0].value.trim(),url:vals[1].value.trim()});}
        let newRadio=[],rdrows=radioSet.querySelectorAll('.item-row');
        for(let row of rdrows){let vals=row.querySelectorAll('input');if(!vals[0].value.trim())continue;
          newRadio.push({name:vals[0].value.trim(),url:vals[1].value.trim()});}
        let newGames=[],grows=gamesSet.querySelectorAll('.item-row');
        for(let row of grows){let vals=row.querySelectorAll('input');if(!vals[0].value.trim())continue;
          newGames.push({name:vals[0].value.trim(),url:vals[1].value.trim(),w:vals[2].value.trim(),h:vals[3].value.trim()});}
        let form = settingsPanel.querySelector('#interfaceColorForm');
        let cz = {
          record_on: form.colRecOn.value,   record_off: form.colRecOff.value,
          btn_header_bg: form.colBtnBg.value, btn_header_text: form.colBtnText.value,
          header_bg: form.colHeaderBg.value, main_bg: form.colMainBg.value, card_bg: form.colCardBg.value,
          btn_radius: form.btnRadius.value, btn_width: form.btnWidth.value,btn_height: form.btnHeight.value,
          btn_textsize: form.btnTextsize.value,
          header_height: form.headerHeight.value,main_width: form.mainWidth.value,
          player_width: form.playerWidth.value,player_height: form.playerHeight.value,
          game_win_w: form.gameWinW.value, game_win_h: form.gameWinH.value
        };
        let html = document.documentElement.outerHTML;
        html = html.replace(/(let tvStreams\s*=\s*)\[[^\]]*\]/,"$1"+JSON.stringify(newTV,null,2))
          .replace(/(let radioStreams\s*=\s*)\[[^\]]*\]/,"$1"+JSON.stringify(newRadio,null,2))
          .replace(/(let games\s*=\s*)\[[^\]]*\]/,"$1"+JSON.stringify(newGames,null,2))
          .replace(/(let uiColors\s*=\s*)\{[^\}]*\}/,"$1"+JSON.stringify(cz,null,2));
        let blob = new Blob([html],{type:'text/html'});
        let url = URL.createObjectURL(blob);
        let a=document.createElement('a');a.href=url;a.download="index.html";a.click();
        URL.revokeObjectURL(url);
      };
    }
    function renderAll(){renderVideoStreams(); renderAudioStreams(); renderGamesMenu(); applyVars();}
    function startup(){renderAll();activateRadio();}
    document.addEventListener('DOMContentLoaded',startup);
    document.onkeydown = function(e){
      if(settingsOpen && e.key==="Escape"){
        settingsPanelBg.style.display=settingsPanel.style.display='none';settingsOpen=false;
      }
      if(document.activeElement.tagName==="INPUT")return;
      if(e.key==="1"){activateTV();}
      if(e.key==="2"){activateRadio();}
      if(e.key==="3"){showGamesMenu();}
    }
  </script>
</body>
</html>
